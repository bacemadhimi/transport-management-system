<mat-card class="user-form-card">
  <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
    <header class="user-form-card__header">
      <div>
        <h2>{{ data.userId ? 'Modifier utilisateur' : 'Ajouter utilisateur' }}</h2>
      </div>
    </header>

    <mat-tab-group animationDuration="0ms" class="user-form-tabs">
      
      <mat-tab label="Informations de base">
        <div class="tab-content">
          <form [formGroup]="userForm" class="user-form-grid">
            <div class="form-row">
              <div class="form-field-group">
                <mat-label>Nom complet</mat-label>
                <mat-form-field appearance="outline" class="user-field">
                  <input matInput formControlName="name" placeholder="Ex: John Doe" />
                  <mat-error *ngIf="userForm.get('name')?.hasError('required')">Nom obligatoire</mat-error>
                  <mat-error *ngIf="userForm.get('name')?.hasError('minlength')">Minimum 2 caractères</mat-error>
                </mat-form-field>
              </div>

              <div class="form-field-group">
                <mat-label>Email</mat-label>
                <mat-form-field appearance="outline" class="user-field">
                  <input matInput type="email" formControlName="email" placeholder="Ex: john.doe@example.com" />
                  <mat-error *ngIf="userForm.get('email')?.hasError('required')">Email obligatoire</mat-error>
                  <mat-error *ngIf="userForm.get('email')?.hasError('email')">Format email invalide</mat-error>
                </mat-form-field>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field-group">
                <mat-label>Téléphone</mat-label>
                <div class="mat-phone-field">
                  <div class="mat-phone-wrapper">
                    <input
                      matInput
                      formControlName="phone"
                      #phoneInput
                      placeholder="Ex: +216 55 123 456"
                    />
                  </div>
                  <mat-error *ngIf="userForm.get('phone')?.invalid && userForm.get('phone')?.touched">
                    {{ getErrorMessage('phone') }}
                  </mat-error>
                </div>
              </div>
            </div>

            <div class="form-row" *ngIf="data.userId">
              <div class="form-field-group">
                <mat-label>Ancien mot de passe</mat-label>
                <mat-form-field appearance="outline" class="user-field">
                  <input
                    matInput
                    formControlName="oldPassword"
                    [type]="hideOldPassword ? 'password' : 'text'"
                    placeholder="••••••••"
                    autocomplete="old-password"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hideOldPassword = !hideOldPassword"
                    [attr.aria-label]="'Hide password'"
                    [attr.aria-pressed]="hideOldPassword"
                  >
                    <mat-icon>{{ hideOldPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  <mat-hint>Requis uniquement si vous modifiez le mot de passe</mat-hint>
                  <mat-error *ngIf="userForm.hasError('oldPasswordRequired')">
                    L'ancien mot de passe est requis pour modifier le mot de passe
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field-group">
                <mat-label>{{ data.userId ? 'Nouveau mot de passe' : 'Mot de passe' }}</mat-label>
                <mat-form-field appearance="outline" class="user-field">
                  <input
                    matInput
                    formControlName="password"
                    [type]="hidePassword ? 'password' : 'text'"
                    placeholder="••••••••"
                    autocomplete="actual-password"
                    (input)="checkPasswordStrength()"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hidePassword = !hidePassword"
                    [attr.aria-label]="'Hide password'"
                    [attr.aria-pressed]="hidePassword"
                  >
                    <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  
                  <div class="password-strength-container" *ngIf="userForm.get('password')?.value">
                    <div class="strength-text">
                      <strong [style.color]="getStrengthColor()">{{ getPasswordStrengthText() }}</strong>
                    </div>
                    
                    <div class="strength-segments">
                      <div class="segment" 
                           [style.background-color]="passwordStrength >= 1 ? '#ff4444' : '#e0e0e0'"></div>
                      <div class="segment" 
                           [style.background-color]="passwordStrength >= 2 ? '#ff8800' : '#e0e0e0'"></div>
                      <div class="segment" 
                           [style.background-color]="passwordStrength >= 3 ? '#ffcc00' : '#e0e0e0'"></div>
                      <div class="segment" 
                           [style.background-color]="passwordStrength >= 4 ? '#44cc44' : '#e0e0e0'"></div>
                      <div class="segment" 
                           [style.background-color]="passwordStrength >= 5 ? '#008800' : '#e0e0e0'"></div>
                    </div>
                    
                    <div class="password-requirements">
                      <div class="requirement" [style.color]="passwordRequirements.minLength ? '#000000' : '#666666'">
                        <span class="requirement-icon" 
                              [style.color]="passwordRequirements.minLength ? '#00aa00' : '#999999'">
                          {{ passwordRequirements.minLength ? '✓' : '○' }}
                        </span>
                        <span class="requirement-text">8 caractères minimum</span>
                      </div>
                      <div class="requirement" [style.color]="passwordRequirements.hasUppercase ? '#000000' : '#666666'">
                        <span class="requirement-icon" 
                              [style.color]="passwordRequirements.hasUppercase ? '#00aa00' : '#999999'">
                          {{ passwordRequirements.hasUppercase ? '✓' : '○' }}
                        </span>
                        <span class="requirement-text">1 lettre majuscule</span>
                      </div>
                      
                      <div class="requirement" [style.color]="passwordRequirements.hasLowercase ? '#000000' : '#666666'">
                        <span class="requirement-icon" 
                              [style.color]="passwordRequirements.hasLowercase ? '#00aa00' : '#999999'">
                          {{ passwordRequirements.hasLowercase ? '✓' : '○' }}
                        </span>
                        <span class="requirement-text">1 lettre minuscule</span>
                      </div>
                      
                      <div class="requirement" [style.color]="passwordRequirements.hasNumber ? '#000000' : '#666666'">
                        <span class="requirement-icon" 
                              [style.color]="passwordRequirements.hasNumber ? '#00aa00' : '#999999'">
                          {{ passwordRequirements.hasNumber ? '✓' : '○' }}
                        </span>
                        <span class="requirement-text">1 chiffre</span>
                      </div>
                      
                      <div class="requirement" [style.color]="passwordRequirements.hasSpecialChar ? '#000000' : '#666666'">
                        <span class="requirement-icon" 
                              [style.color]="passwordRequirements.hasSpecialChar ? '#00aa00' : '#999999'">
                          {{ passwordRequirements.hasSpecialChar ? '✓' : '○' }}
                        </span>
                        <span class="requirement-text">1 caractère spécial (@$!%*?&)</span>
                      </div>
                    </div>
                  </div>
                  
                  <mat-hint *ngIf="data.userId">Laisser vide pour conserver le mot de passe actuel</mat-hint>
                  <mat-error *ngIf="userForm.get('password')?.hasError('required') && !data.userId">
                    Mot de passe obligatoire
                  </mat-error>
                  <mat-error *ngIf="userForm.get('password')?.hasError('pattern')">
                    Le mot de passe ne respecte pas les exigences de sécurité
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-field-group">
                <mat-label>Confirmer le {{ data.userId ? 'nouveau ' : '' }}mot de passe</mat-label>
                <mat-form-field appearance="outline" class="user-field">
                  <input
                    matInput
                    formControlName="confirmPassword"
                    [type]="hideConfirmPassword ? 'password' : 'text'"
                    placeholder="••••••••"
                    autocomplete="current-password"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    type="button"
                    (click)="hideConfirmPassword = !hideConfirmPassword"
                    [attr.aria-label]="'Hide password'"
                    [attr.aria-pressed]="hideConfirmPassword"
                  >
                    <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
                  </button>
                  <mat-error *ngIf="userForm.get('confirmPassword')?.hasError('required') && !data.userId">
                    Confirmation du mot de passe obligatoire
                  </mat-error>
                  <mat-error *ngIf="userForm.hasError('passwordMismatch')">
                    Les mots de passe ne correspondent pas
                  </mat-error>
                  
                  <div class="match-indicator" *ngIf="userForm.get('password')?.value && userForm.get('confirmPassword')?.value">
                    <span *ngIf="!userForm.hasError('passwordMismatch')" style="color: #00aa00; font-weight: 500;">
                      ✓ Les mots de passe correspondent
                    </span>
                    <span *ngIf="userForm.hasError('passwordMismatch')" style="color: #ff4444; font-weight: 500;">
                      ✗ Les mots de passe ne correspondent pas
                    </span>
                  </div>
                </mat-form-field>
              </div>
            </div>

            <div class="user-photo-input">
              <mat-label style="display: block; margin-bottom: 8px; text-align: center;">
                Photo de profil
              </mat-label>

              <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">
                <button mat-stroked-button type="button" (click)="fileInput.click()">
                  <mat-icon>cloud_upload</mat-icon>
                  {{ hasPhoto ? 'Changer la photo' : 'Choisir une photo' }}
                </button>
                
                <button 
                  *ngIf="hasPhoto" 
                  mat-stroked-button 
                  type="button" 
                  color="warn"
                  (click)="onDeletePhoto()"
                  matTooltip="Supprimer la photo"
                >
                  <mat-icon>delete</mat-icon>
                  Supprimer
                </button>
              </div>

              <input
                #fileInput
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                style="display: none"
              />
              
              <div *ngIf="fileError" style="color: red; margin-top: 5px;">
                {{ fileError }}
              </div>

              <div class="image-preview-container" *ngIf="hasPhoto; else noPhotoTemplate">
                <div class="image-wrapper">
                  <img
                    [src]="imagePreview || ('data:image/png;base64,' + originalImageBase64)"
                    alt="Photo de profil"
                    class="user-image"
                  />
                </div>
                <p *ngIf="isPhotoChanged" class="photo-changed-hint">
                  ✓ Photo modifiée
                </p>
              </div>

              <ng-template #noPhotoTemplate>
                <div class="no-photo-placeholder">
                  <mat-icon style="font-size: 48px; color: #ccc; margin-bottom: 8px;">
                    person
                  </mat-icon>
                  <p style="color: #888; margin: 0;">Aucune photo</p>
                </div>
              </ng-template>
            </div>
          </form>
        </div>
      </mat-tab>

      <!-- Rôle Tab -->
      <mat-tab label="Rôle">
        <div class="tab-content">
          <div class="drag-drop-container">
          
            <div class="drag-drop-header">
              <h3>Association du rôle</h3>
              <p class="subtitle">Glissez-déposez UN SEUL rôle pour l'utilisateur</p>
              
              <div class="search-container">
                <mat-form-field appearance="outline" class="search-field">
                  <mat-label>Rechercher un rôle</mat-label>
                  <input 
                    matInput 
                    [(ngModel)]="searchTerm" 
                    (input)="filterRoles()"
                    placeholder="Nom du rôle..."
                  />
                  <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
              </div>
            </div>

            <div class="drag-drop-columns">
              <!-- Available Roles Column -->
              <div class="drag-drop-column">
                <div class="column-header">
                  <h4>Rôles disponibles</h4>
                  <span class="badge badge-available">{{ availableRoles.length }}</span>
                </div>
                <div class="drag-drop-list" 
                     cdkDropList
                     id="availableList"
                     #availableList="cdkDropList"
                     [cdkDropListData]="availableRoles"
                     [cdkDropListConnectedTo]="[memberList]"
                     (cdkDropListDropped)="drop($event)">
                  
                  <div *ngIf="availableRoles.length === 0" class="empty-list">
                    <mat-icon>check_circle</mat-icon>
                    <p>Tous les rôles sont attribués</p>
                  </div>
                  
                  <div *ngFor="let role of filteredAvailableRoles" 
                       class="drag-item"
                       cdkDrag
                       [cdkDragData]="role"
                       [class.disabled]="memberRoles.length > 0">
                    <div class="drag-item-content">
                      <div class="drag-icon">
                        <mat-icon>drag_indicator</mat-icon>
                      </div>
                      <div class="role-info">
                        <strong>{{role.name}}</strong>
                      </div>
                      <div *ngIf="memberRoles.length > 0" class="single-selection-overlay">
                        <mat-icon>block</mat-icon>
                        <span>Un seul rôle autorisé</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="drag-drop-divider">
                <div class="divider-arrows">
                  <mat-icon>arrow_forward</mat-icon>
                  <mat-icon>arrow_back</mat-icon>
                </div>
                <p>Glisser-déposer</p>
              </div>

              <!-- Selected Role Column (max 1 item) -->
              <div class="drag-drop-column">
                <div class="column-header">
                  <h4>Rôle attribué</h4>
                  <span class="badge badge-member">{{ memberRoles.length }}/1</span>
                </div>
                <div class="drag-drop-list" 
                     cdkDropList
                     id="memberList"
                     #memberList="cdkDropList"
                     [cdkDropListData]="memberRoles"
                     [cdkDropListConnectedTo]="[availableList]"
                     (cdkDropListDropped)="drop($event)">
                  
                  <div *ngIf="memberRoles.length === 0" class="empty-list">
                    <mat-icon>person_add</mat-icon>
                    <p>Aucun rôle attribué</p>
                    <small>Glissez un rôle ici ou cliquez sur le bouton "+"</small>
                  </div>
                  
                  <div *ngFor="let role of filteredMemberRoles" 
                       class="drag-item selected"
                       cdkDrag
                       [cdkDragData]="role">
                    <div class="drag-item-content">
                      <div class="drag-icon">
                        <mat-icon>drag_indicator</mat-icon>
                      </div>
                      <div class="role-info">
                        <strong>{{role.name}}</strong>
                      </div>
                      <button mat-icon-button 
                              color="warn" 
                              class="remove-btn"
                              (click)="removeFromMemberRoles(role)"
                              matTooltip="Retirer le rôle">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
              <div class="action-buttons">
                <button mat-stroked-button 
                        (click)="addToMemberRoles()" 
                        [disabled]="availableRoles.length === 0 || memberRoles.length > 0">
                  <mat-icon>add_circle_outline</mat-icon>
                  Ajouter un rôle
                </button>
                <button mat-stroked-button 
                        (click)="removeAllRoles()" 
                        [disabled]="memberRoles.length === 0">
                  <mat-icon>remove_circle_outline</mat-icon>
                  Retirer
                </button>
              </div>
              
              <div class="selection-info">
                <mat-icon>info</mat-icon>
                <span>Maximum 1 rôle par utilisateur</span>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Footer buttons -->
    <div class="form-footer">
      <button mat-button color="warn" type="button" (click)="onCancel()" [disabled]="isSubmitting">
        <mat-icon>close</mat-icon>
        Annuler
      </button>
      <button mat-flat-button color="primary" type="button" 
              (click)="onSubmit()" 
              [disabled]="userForm.invalid || isSubmitting">
        <mat-spinner *ngIf="isSubmitting" diameter="20" class="inline-block mr-2"></mat-spinner>
        <mat-icon>save</mat-icon>
        {{ data.userId ? 'Enregistrer' : 'Ajouter' }}
      </button>
    </div>
  </div>
</mat-card>