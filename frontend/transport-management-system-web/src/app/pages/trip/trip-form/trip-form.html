<mat-card class="trip-form-card">
  <header class="trip-form-card__header">
    <div>
      <h2>{{ data.tripId ? 'Modifier voyage' : 'Ajouter voyage' }}</h2>
    </div>
    <button mat-icon-button (click)="onCancel()">
      <mat-icon>close</mat-icon>
    </button>
  </header>

  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <span>Chargement...</span>
  </div>

  <form [formGroup]="tripForm" (ngSubmit)="onSubmit()">
    <!-- Référence du trajet -->
    <mat-form-field appearance="outline" class="trip-field trip-field--wide">
      <mat-label>Référence du voyage</mat-label>
      <input
        matInput
        formControlName="tripReference"
        placeholder="Ex: LIV-2024-001"
      />
      <mat-error *ngIf="tripForm.get('tripReference')?.hasError('required')">
        La référence du voyage est obligatoire
      </mat-error>
      <mat-error *ngIf="tripForm.get('tripReference')?.hasError('maxlength')">
        Maximum 50 caractères
      </mat-error>
    </mat-form-field>

    <!-- Dates estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de début estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedStartDatePicker"
          formControlName="estimatedStartDate"
          placeholder="Date de début estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedStartDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedStartDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedStartDate')?.hasError('required')">
          La date de début estimée est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de fin estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedEndDatePicker"
          formControlName="estimatedEndDate"
          placeholder="Date de fin estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedEndDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedEndDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedEndDate')?.hasError('required')">
          La date de fin estimée est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Camion & Chauffeur -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Camion</mat-label>
        <mat-select formControlName="truckId" placeholder="Sélectionner un camion">
          <mat-option *ngFor="let truck of trucks" [value]="truck.id">
            {{ truck.immatriculation }} - {{ truck.brand }}
            <span class="text-gray-500 text-sm ml-2">
              (Capacité: {{ truck.capacity }} kg)
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('truckId')?.hasError('required')">
          La sélection d'un camion est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Chauffeur</mat-label>
        <mat-select formControlName="driverId" placeholder="Sélectionner un chauffeur">
          <mat-option *ngFor="let driver of drivers" [value]="driver.id">
            {{ driver.name }}
            <span class="text-gray-500 text-sm ml-2">
              ({{ driver.permisNumber }})
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('driverId')?.hasError('required')">
          La sélection d'un chauffeur est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Distance & Durée estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Distance estimée (km)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDistance"
          min="0.1"
          step="0.1"
          placeholder="Ex: 150.5"
          (blur)="onDistanceBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('required')">
          La distance estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('min')">
          La distance doit être au moins 0.1 km
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Durée estimée (heures)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDuration"
          min="0.1"
          step="0.1"
          placeholder="Ex: 3.5"
          (blur)="onDurationBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('required')">
          La durée estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('min')">
          La durée doit être au moins 0.1 heure
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Statut -->
    <mat-form-field appearance="outline" class="trip-field trip-field--wide">
      <mat-label>Statut du voyage</mat-label>
      <mat-select formControlName="tripStatus" placeholder="Sélectionner un statut">
        <mat-option *ngFor="let status of tripStatuses" [value]="status.value">
          {{ status.label }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="tripForm.get('tripStatus')?.hasError('required')">
        Le statut du voyage est obligatoire
      </mat-error>
    </mat-form-field>

    <!-- Quick add section -->
    <div class="quick-add-section" *ngIf="ordersForQuickAdd.length > 0 && !data.tripId">
      <div class="section-header">
        <h3>Ajout rapide de commandes</h3>
        <p class="text-sm text-gray-500">Commandes disponibles en attente de livraison</p>
      </div>
      
      <div class="quick-add-grid">
        <div *ngFor="let order of ordersForQuickAdd" class="quick-add-card" (click)="quickAddOrder(order)">
          <div class="quick-add-header">
            <div class="order-ref">{{ order.reference }}</div>
          </div>
          <div class="quick-add-content">
            <div class="quick-add-client">{{ getClientName(order.customerId) }}</div>
            <div class="quick-add-address">{{ getClientAddress(order.customerId) }}</div>
            <div class="quick-add-meta">
              <span class="weight">{{ order.weight }} kg</span>
              <span class="status">{{ order.status }}</span>
            </div>
          </div>
          <button mat-icon-button class="quick-add-btn">
            <mat-icon>add_circle</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Section des livraisons -->
    <div class="deliveries-section" formArrayName="deliveries">
      <div class="section-header">
        <h3>Livraisons</h3>
        <div class="section-header-actions">
          <p class="text-sm text-gray-500">Ajoutez les points de livraison avec leurs clients et commandes</p>
          <button 
            mat-stroked-button 
            type="button" 
            (click)="addDelivery()"
            class="add-delivery-top-btn"
          >
            <mat-icon>add</mat-icon>
            Ajouter une livraison
          </button>
        </div>
      </div>
      
      <!-- Simple Delivery Form Fields -->
        <div class="simple-deliveries" *ngIf="deliveries.length > 0">
        <div *ngFor="let deliveryGroup of deliveryControls; let i = index"
            [formGroupName]="i"
            class="simple-delivery-card">
          
          <div class="delivery-card-header">
            <div class="delivery-title">
              <mat-icon class="delivery-icon">local_shipping</mat-icon>
              <h4>Livraison {{ i + 1 }}</h4>
            </div>
            <div class="delivery-actions">
              <span class="sequence-badge">#{{ deliveryGroup.get('sequence')?.value }}</span>
              <button 
                mat-icon-button 
                type="button" 
                (click)="removeDelivery(i)"
                *ngIf="deliveries.length > 1"
                class="remove-delivery-btn"
                matTooltip="Supprimer cette livraison"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="delivery-form-grid">
            <!-- Client Selection -->
            <div class="form-group">
              <label class="form-label">Client *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <mat-select formControlName="customerId" (selectionChange)="onCustomerChange(i)" placeholder="Sélectionner un client">
                  <mat-option *ngFor="let customer of customers" [value]="customer.id">
                    <div class="client-option-simple">
                      <div class="client-name">{{ customer.name }}</div>
                      <div *ngIf="customer.matricule" class="client-matricule">
                        {{ customer.matricule }}
                      </div>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deliveryGroup.get('customerId')?.hasError('required')">
                  La sélection d'un client est obligatoire
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Order Selection -->
            <div class="form-group">
              <label class="form-label">Commande *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <mat-select formControlName="orderId" placeholder="Sélectionner une commande">
                  <mat-option *ngFor="let order of getCustomerOrders(i)" [value]="order.id">
                    <div class="order-option">
                      <div class="order-ref">{{ order.reference }}</div>
                      <div class="order-details">
                        <span class="order-type">{{ order.type || 'Non spécifié' }}</span>
                        <span class="order-weight">{{ order.weight }} kg</span>
                      </div>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deliveryGroup.get('orderId')?.hasError('required')">
                  La sélection d'une commande est obligatoire
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Order Preview Card -->
            <div class="order-preview-card" *ngIf="deliveryGroup.get('orderId')?.value">
              <div class="preview-header">
                <mat-icon>info</mat-icon>
                <span>Détails de la commande</span>
              </div>
              <div class="preview-content">
                <div class="preview-row">
                  <span class="preview-label">Référence:</span>
                  <span class="preview-value">{{ getOrderReference(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Type:</span>
                  <span class="preview-value">{{ getOrderType(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Poids:</span>
                  <span class="preview-value">{{ getOrderWeight(deliveryGroup.get('orderId')?.value) }} kg</span>
                </div>
              </div>
            </div>

            <!-- Delivery Address -->
            <div class="form-group full-width">
              <label class="form-label">Adresse de livraison *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="deliveryAddress"
                  placeholder="Ex: Rue de la Paix, 75001 Paris"
                  rows="2"
                ></textarea>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('required')">
                  L'adresse de livraison est obligatoire
                </mat-error>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('maxlength')">
                  Maximum 500 caractères
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Sequence and Time -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="form-label">Ordre de livraison</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="number"
                    formControlName="sequence"
                    min="1"
                    [max]="deliveries.length"
                    placeholder="Ex: 1"
                  />
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('required')">
                    L'ordre de livraison est obligatoire
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('min')">
                    L'ordre doit être au moins 1
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('max')">
                    L'ordre ne peut pas dépasser {{ deliveries.length }}
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-group">
                <label class="form-label">Heure prévue</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="time"
                    formControlName="plannedTime"
                    placeholder="HH:MM"
                  />
                </mat-form-field>
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group full-width">
              <label class="form-label">Notes (optionnel)</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="notes"
                  placeholder="Informations supplémentaires..."
                  rows="2"
                ></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="deliveries.length === 0" class="empty-deliveries">
        <mat-icon class="empty-icon">local_shipping</mat-icon>
        <h4>Aucune livraison ajoutée</h4>
        <p>Commencez par ajouter des points de livraison à votre trajet</p>
        <button 
          mat-raised-button 
          color="primary" 
          type="button" 
          (click)="addDelivery()"
          class="add-first-delivery-btn"
        >
          <mat-icon>add</mat-icon>
          Ajouter la première livraison
        </button>
      </div>

      <!-- Visual Timeline Summary -->
      <div class="timeline-summary" *ngIf="deliveries.length > 0">
        <div class="summary-header">
          <h4>Récapitulatif du trajet</h4>
          <mat-icon>route</mat-icon>
        </div>
        
        <div class="timeline-flow">
          <!-- Start Point -->
          <div class="timeline-step start-step">
            <div class="step-marker">
              <mat-icon>play_arrow</mat-icon>
            </div>
            <div class="step-content">
              <div class="step-title">Départ</div>
              <div class="step-details">
               <!-- Change pipe to method call -->
                <div><strong>Date:</strong> {{ formatDateForDisplay(tripForm.get('estimatedEndDate')?.value) }}</div>
                <div><strong>Camion:</strong> {{ getSelectedTruckInfo() }}</div>
              </div>
            </div>
          </div>

          <!-- Delivery Points -->
          <div class="delivery-steps">
            <div *ngFor="let deliveryGroup of deliveryControls; let i = index" class="timeline-step delivery-step">
              <div class="step-connector">
                <div class="connector-line"></div>
                <div class="connector-arrow">↓</div>
                <div class="connector-label">Livraison {{ i + 1 }}</div>
              </div>
              
              <div class="step-marker">
                <span class="delivery-number">{{ i + 1 }}</span>
              </div>
              
              <div class="step-content">
                <div class="step-title">Livraison {{ i + 1 }}</div>
                <div class="step-details">
                  <div><strong>Client:</strong> {{ getClientName(deliveryGroup.get('customerId')?.value) }}</div>
                  <div><strong>Commande:</strong> {{ getOrderReference(deliveryGroup.get('orderId')?.value) }}</div>
                  <div class="address-preview">
                    {{ deliveryGroup.get('deliveryAddress')?.value  }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- End Point -->
          <div class="timeline-step end-step">
            <div class="step-connector">
              <div class="connector-line"></div>
              <div class="connector-arrow">↓</div>
              <div class="connector-label">Fin</div>
            </div>
            
            <div class="step-marker">
              <mat-icon>flag</mat-icon>
            </div>
            
            <div class="step-content">
              <div class="step-title">Arrivée</div>
              <div class="step-details">
                <div><strong>Date:</strong> {{ tripForm.get('estimatedEndDate')?.value | date:'dd MMM yyyy' }}</div>
                <div><strong>Distance:</strong> {{ tripForm.get('estimatedDistance')?.value }} km</div>
                <div><strong>Durée:</strong> {{ tripForm.get('estimatedDuration')?.value }}h</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-footer">
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="tripForm.invalid || deliveries.length === 0 || loading"
      >
        <span *ngIf="loading">Envoi en cours...</span>
        <span *ngIf="!loading">{{ data.tripId ? 'Enregistrer' : 'Créer le voyage' }}</span>
      </button>
      <button mat-button type="button" (click)="onCancel()" [disabled]="loading">Annuler</button>
    </div>
  </form>
</mat-card>