<mat-card class="trip-form-card">
  <header class="trip-form-card__header">
    <div>
      <h2>{{ data.tripId ? 'Modifier voyage' : 'Ajouter voyage' }}</h2>
    </div>
  </header>

  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <span>Chargement...</span>
  </div>

  <form [formGroup]="tripForm" (ngSubmit)="onSubmit()">
    <!-- Dates estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de début estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedStartDatePicker"
          formControlName="estimatedStartDate"
          placeholder="Date de début estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedStartDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedStartDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedStartDate')?.hasError('required')">
          La date de début estimée est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de fin estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedEndDatePicker"
          formControlName="estimatedEndDate"
          placeholder="Date de fin estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedEndDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedEndDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedEndDate')?.hasError('required')">
          La date de fin estimée est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Camion & Chauffeur -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Camion</mat-label>
        <mat-select formControlName="truckId" placeholder="Sélectionner un camion">
          <mat-option *ngFor="let truck of trucks" [value]="truck.id">
            {{ truck.immatriculation }} - {{ truck.brand }}
            <span class="text-gray-500 text-sm ml-2">
              (Capacité: {{ truck.capacity }} kg)
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('truckId')?.hasError('required')">
          La sélection d'un camion est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Chauffeur</mat-label>
        <mat-select formControlName="driverId" placeholder="Sélectionner un chauffeur">
          <mat-option *ngFor="let driver of drivers" [value]="driver.id">
            {{ driver.name }}
            <span class="text-gray-500 text-sm ml-2">
              ({{ driver.permisNumber }})
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('driverId')?.hasError('required')">
          La sélection d'un chauffeur est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Distance & Durée estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Distance estimée (km)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDistance"
          min="0.1"
          step="0.1"
          placeholder="Ex: 150.5"
          (blur)="onDistanceBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('required')">
          La distance estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('min')">
          La distance doit être au moins 0.1 km
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Durée estimée (heures)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDuration"
          min="0.1"
          step="0.1"
          placeholder="Ex: 3.5"
          (blur)="onDurationBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('required')">
          La durée estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('min')">
          La durée doit être au moins 0.1 heure
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Statut -->
    <mat-form-field appearance="outline" class="trip-field trip-field--wide">
      <mat-label>Statut du voyage</mat-label>
      <mat-select formControlName="tripStatus" placeholder="Sélectionner un statut">
        <mat-option *ngFor="let status of tripStatuses" [value]="status.value">
          {{ status.label }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="tripForm.get('tripStatus')?.hasError('required')">
        Le statut du voyage est obligatoire
      </mat-error>
    </mat-form-field>

    <!-- Section Traject Configuration (Only for creation) -->
    <div class="traject-section" *ngIf="!data.tripId">
      <div class="section-header">
        <div>
          <h3>Configuration du Trajet</h3>
          <p class="text-sm text-gray-500">
            Choisissez entre un itinéraire prédéfini ou créez-en un nouveau à partir des livraisons
          </p>
        </div>
      </div>

      <!-- Choice between predefined or new traject -->
      <div class="traject-choice">
        <mat-radio-group [(ngModel)]="trajectMode" (change)="onTrajectModeChange()" name="trajectMode"  [ngModelOptions]="{standalone: true}">
          <div class="radio-option">
            <mat-radio-button value="predefined">
              <div class="option-content">
                <mat-icon class="option-icon">route</mat-icon>
                <div class="option-text">
                  <div class="option-title">Utiliser un traject prédéfini</div>
                  <div class="option-description">Sélectionnez un itinéraire standard enregistré</div>
                </div>
              </div>
            </mat-radio-button>
          </div>
          
          <div class="radio-option">
            <mat-radio-button value="new">
              <div class="option-content">
                <mat-icon class="option-icon">add_road</mat-icon>
                <div class="option-text">
                  <div class="option-title">Créer un nouveau trajet</div>
                  <div class="option-description">Définissez le trajet à partir des points de livraison</div>
                </div>
              </div>
            </mat-radio-button>
          </div>
        </mat-radio-group>
      </div>

      <!-- Predefined Traject Selection --> 
      <div *ngIf="trajectMode === 'predefined'">
      <div class="traject-selection-section">
        <div class="selection-header">
          <div>
            <h4>Sélection du traject prédéfini</h4>
            <p class="text-sm text-gray-500">Choisissez un itinéraire standard</p>
          </div>
        </div>
        
        <div class="traject-selection">
          <mat-form-field appearance="outline" class="traject-field full-width">
            
            <mat-select
              [formControl]="selectedTrajectControl"
              (selectionChange)="onTrajectSelected($event.value)"
              [disabled]="loadingTrajects"
            >
              <mat-option [value]="null">-- Aucun --</mat-option>
              <mat-option *ngFor="let traject of trajects" [value]="traject.id">
                <div class="traject-option">
                  <div class="traject-name">{{ traject.name }}</div>
                  <div class="traject-info">
                    <span class="traject-points">
                      <mat-icon class="icon-small">location_on</mat-icon>
                      {{ traject.points?.length || 0 }} points
                    </span>
                  </div>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Sélectionnez un traject pour pré-remplir les estimations</mat-hint>
          </mat-form-field>
          
          <!-- Loading state -->
          <div *ngIf="loadingTrajects" class="loading-trajects">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Chargement des trajects...</span>
          </div>
        </div>
        
        <!-- Selected Traject Preview -->
        <div *ngIf="selectedTraject" class="selected-traject-preview">
          <div class="preview-header">
            <div class="preview-title">
              <!-- Mode édition pour le nom du traject -->
              <div *ngIf="isEditingTrajectName; else viewMode">
                <mat-form-field appearance="outline" class="traject-name-edit">
                  <input
                    matInput
                    [(ngModel)]="editingTrajectName"
                    (blur)="saveTrajectName()"
                    (keyup.enter)="saveTrajectName()"
                    placeholder="Nom du traject"
                    maxlength="100"
                    [ngModelOptions]="{standalone: true}"
                    #nameInput
                  >
                  <mat-hint>{{ editingTrajectName?.length || 0 }}/100</mat-hint>
                </mat-form-field>
                <div class="edit-actions">
                  <button mat-icon-button (click)="saveTrajectName()" color="primary" matTooltip="Sauvegarder">
                    <mat-icon>check</mat-icon>
                  </button>
                  <button mat-icon-button (click)="cancelTrajectNameEdit()" matTooltip="Annuler">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              </div>
              
              <ng-template #viewMode>
                <h4>Traject sélectionné</h4>
                <div class="traject-name-actions">
                  <span class="traject-badge">{{ selectedTraject.name }}</span>
                  <button mat-icon-button (click)="startTrajectNameEdit()" class="edit-name-btn" matTooltip="Modifier le nom">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
              </ng-template>
            </div>
            
            <div class="preview-actions">
              <button mat-button type="button" 
                    (click)="deleteTraject()"
                    class="delete-traject-btn"
                    color="warn"
                    [disabled]="savingTrajectChanges || deletingTraject">
              <mat-icon *ngIf="!deletingTraject">delete</mat-icon>
              <mat-spinner *ngIf="deletingTraject" diameter="20"></mat-spinner>
              {{ deletingTraject ? 'Suppression...' : 'Supprimer' }}
            </button>
            </div>
          </div>
          
          <!-- Traject Visualization with Drag & Drop -->
          <div class="traject-visualization">
            <div class="traject-visualization__header">
              <mat-icon class="start-icon">flag</mat-icon>
              <div class="traject-summary">
                <span class="total-points">
                  <mat-icon class="summary-icon">location_on</mat-icon>
                  {{ selectedTraject.points?.length }} points
                </span>
                <span class="distance-estimate">
                  <mat-icon class="summary-icon">directions_car</mat-icon>
                  ~ {{ calculateTrajectDistance() }} km
                </span>
              </div>
              <mat-icon class="end-icon">flag</mat-icon>
            </div>
            
            <!-- Drag & Drop Container for Traject Points -->
            <div class="points-list" 
                 cdkDropList
                 [cdkDropListData]="selectedTraject.points"
                 (cdkDropListDropped)="dropTrajectPoint($event)"
                 [cdkDropListDisabled]="!selectedTraject || savingTrajectChanges">
              
              <!-- Points de traject avec drag & drop -->
              <div *ngFor="let point of selectedTraject.points; let i = index" 
                   class="point-item"
                   cdkDrag
                   [cdkDragData]="point">
                
                <!-- Drag Handle -->
                <div class="drag-handle" cdkDragHandle *ngIf="!savingTrajectChanges">
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                
                <div class="point-marker">
                  <div class="point-order">{{ point.order }}</div>
                </div>
                
                <div class="point-content">
                  <!-- Mode édition pour l'adresse -->
                  <div *ngIf="isEditingPoint === i; else pointView">
                    <mat-form-field appearance="outline" class="point-address-edit">
                      <textarea
                        matInput
                        [(ngModel)]="editingPointAddress"
                        (blur)="savePointAddress(i)"
                        (keyup.enter)="savePointAddress(i)"
                        placeholder="Adresse complète"
                        rows="2"
                        maxlength="500"
                        [ngModelOptions]="{standalone: true}"
                        #addressInput
                      ></textarea>
                      <mat-hint>{{ editingPointAddress?.length || 0 }}/500</mat-hint>
                    </mat-form-field>
                    <div class="point-edit-actions">
                      <button mat-icon-button (click)="savePointAddress(i)" color="primary" matTooltip="Sauvegarder">
                        <mat-icon>check</mat-icon>
                      </button>
                      <button mat-icon-button (click)="cancelPointEdit()" matTooltip="Annuler">
                        <mat-icon>close</mat-icon>
                      </button>
                      <button mat-icon-button (click)="deleteTrajectPoint(i)" color="warn" matTooltip="Supprimer" *ngIf="selectedTraject.points.length > 1">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                  
                  <ng-template #pointView>
                    <div class="point-location">{{ point.location }}</div>
                    <div class="point-type">Point de passage</div>
                    <div class="point-actions">
                      <button mat-icon-button (click)="startPointEdit(i, point.location)" class="edit-point-btn" matTooltip="Modifier l'adresse">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <span class="point-distance" *ngIf="i > 0">~15km depuis point {{ i }}</span>
                    </div>
                  </ng-template>
                </div>
              </div>
              
              <!-- Add new point button -->
              <div class="add-point-section" *ngIf="!savingTrajectChanges">
                <button mat-stroked-button type="button" (click)="addNewTrajectPoint()" class="add-point-btn">
                  <mat-icon>add_location</mat-icon>
                  Ajouter un point
                </button>
              </div>
              
              <!-- Loading state during save -->
              <div *ngIf="savingTrajectChanges" class="saving-changes">
                <mat-spinner diameter="20"></mat-spinner>
                <span>Sauvegarde des modifications...</span>
              </div>
            </div>
            
            <!-- Auto-save indicator -->
            <div class="autosave-indicator" *ngIf="hasUnsavedTrajectChanges">
              <mat-icon>sync</mat-icon>
              <span>Modifications non sauvegardées</span>
              <button mat-button color="primary" (click)="saveTrajectChanges()">Sauvegarder</button>
            </div>
          </div>
        </div>
      </div>
     </div>

<!-- Save as Traject Option (only for new traject mode) -->
<div *ngIf="trajectMode === 'new' && deliveries.length > 0" class="save-traject-section">
  <div class="save-header">
    <mat-checkbox 
      [(ngModel)]="saveAsTraject"
      (change)="onSaveAsTrajectChange($event.checked)"
      [ngModelOptions]="{standalone: true}"
    >
      Enregistrer ce trajet comme traject prédéfini
    </mat-checkbox>
    <mat-icon class="info-icon" matTooltip="Pour réutiliser ce trajet dans de futurs voyages">info</mat-icon>
  </div>
  
  <div *ngIf="saveAsTraject" class="traject-name-input">
    <mat-form-field appearance="outline" class="full-width">
      <input
        matInput
        [(ngModel)]="trajectName"
        placeholder="Ex: Paris-Lyon-Marseille"
        maxlength="100"
        required
        [ngModelOptions]="{standalone: true}"
      />
      <mat-error *ngIf="!trajectName && saveAsTraject">
        Le nom du traject est obligatoire
      </mat-error>
      <mat-hint>{{ trajectName?.length || 0 }}/100 caractères</mat-hint>
    </mat-form-field>
    
    <div class="traject-preview-from-deliveries">
      <div class="preview-title">
        <mat-icon>visibility</mat-icon>
        <span>Aperçu du traject à enregistrer</span>
      </div>
      <div class="preview-points">
        <div *ngFor="let deliveryGroup of deliveryControls; let i = index" class="preview-point">
          <div class="preview-order">{{ i + 1 }}</div>
          <div class="preview-address">{{ deliveryGroup.get('deliveryAddress')?.value || 'Adresse non définie' }}</div>
          <div class="preview-client" *ngIf="deliveryGroup.get('customerId')?.value">
            <mat-icon>person</mat-icon>
            {{ getClientName(deliveryGroup.get('customerId')?.value) }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
    </div>

    <!-- Quick add section (only for new traject mode) -->
    <div class="quick-add-section" *ngIf="ordersForQuickAdd.length > 0 && !data.tripId && trajectMode === 'new'">
      <div class="section-header">
        <div class="quick-add-title">
          <h3>Ajout rapide de commandes</h3>
          <p class="text-sm text-gray-500">
            <span class="counter-highlight">{{ filteredOrders.length }}</span> 
            commandes disponibles en attente de livraison
            <span *ngIf="searchControl.value" class="filter-info">
              ({{ ordersForQuickAdd.length }} total)
            </span>
          </p>
        </div>
        
        <!-- Filter and view options -->
        <div class="quick-add-controls">
          <!-- Search Box -->
          <div class="search-box">
            <mat-form-field appearance="outline" class="search-field">
              <input
                matInput
                [formControl]="searchControl"
                placeholder="Client, matricule, adresse, référence..."
              >
              <button
                matSuffix
                mat-icon-button
                *ngIf="searchControl.value"
                (click)="clearSearch()"
                type="button"
                aria-label="Effacer la recherche"
              >
                <mat-icon>close</mat-icon>
              </button>
              <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>
          </div>
          
          <!-- View options -->
          <div class="view-options">
            <span class="view-label">Affichage:</span>
            <button type="button" mat-button 
                    [class.active]="displayMode === 'grid'"
                    (click)="displayMode = 'grid'"
                    class="view-btn">
              <mat-icon>grid_view</mat-icon>
              Grille
            </button>
            <button type="button" mat-button 
                    [class.active]="displayMode === 'list'"
                    (click)="displayMode = 'list'"
                    class="view-btn">
              <mat-icon>view_list</mat-icon>
              Liste
            </button>
          </div>
        </div>
      </div>
      
      <!-- No results message -->
      <div *ngIf="filteredOrders.length === 0 && searchControl.value" class="no-results">
        <mat-icon class="no-results-icon">search_off</mat-icon>
        <h4>Aucun résultat trouvé</h4>
        <p>Aucune commande ne correspond à "{{ searchControl.value }}"</p>
        <button mat-button (click)="clearSearch()" class="clear-filter-btn">
          <mat-icon>clear_all</mat-icon>
          Effacer la recherche
        </button>
      </div>
      
      <!-- Grid with fixed 4x5 layout -->
      <div class="quick-add-container" 
           [class.container-grid]="displayMode === 'grid'"
           [class.container-list]="displayMode === 'list'"
           *ngIf="filteredOrders.length > 0">
        
        <!-- Grid Mode -->
        <div *ngIf="displayMode === 'grid'" class="fixed-grid-view">  
          <div class="grid-container">
            <div *ngFor="let order of filteredOrders" 
                 class="grid-card"
                 (click)="quickAddOrder(order)"
                 [matTooltip]="'Cliquer pour ajouter ' + order.reference">
              
              <div class="grid-card-header">
                <div class="grid-ref">{{ order.reference }}</div>
                <div class="grid-type">{{ order.type || 'Std' }}</div>
              </div>
              
              <div class="grid-card-content">
                <div class="grid-client">{{ getClientName(order.customerId) }}</div>
                <div class="grid-weight">{{ order.weight }} kg</div>
              </div>
              
              <button type="button" mat-icon-button 
                      class="grid-add-btn"
                      (click)="quickAddOrder(order); $event.stopPropagation()">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
        
        <!-- List Mode -->
        <div *ngIf="displayMode === 'list'" class="list-view">
          <div class="list-header">
            <div class="list-col col-ref">Référence</div>
            <div class="list-col col-client">Client</div>
            <div class="list-col col-type">Type</div>
            <div class="list-col col-weight">Poids</div>
            <div class="list-col col-status">Statut</div>
            <div class="list-col col-actions">Actions</div>
          </div>
          
          <div class="list-body">
            <div *ngFor="let order of filteredOrders" 
                 class="list-row"
                 (click)="quickAddOrder(order)">
              
              <div class="list-col col-ref">
                <span class="list-ref">{{ order.reference }}</span>
              </div>
              
              <div class="list-col col-client">
                <span class="list-client">{{ getClientName(order.customerId) }}</span>
              </div>
              
              <div class="list-col col-type">
                <span class="list-type">{{ order.type || 'Standard' }}</span>
              </div>
              
              <div class="list-col col-weight">
                <span class="list-weight">{{ order.weight }} kg</span>
              </div>
              
              <div class="list-col col-status">
                <span class="list-status" [class]="'status-' + order.status.toLowerCase()">
                  {{ order.status }}
                </span>
              </div>
              
              <div class="list-col col-actions">
                <button mat-icon-button type="button"
                        class="list-add-btn"
                        (click)="quickAddOrder(order); $event.stopPropagation()">
                  <mat-icon>add</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add delivery button (always visible when traject mode is selected) -->
    <div class="add-delivery-button-section" *ngIf="trajectMode !== null && (!showDeliveriesSection || deliveries.length === 0)">
      <div class="add-delivery-prompt">
        <mat-icon class="prompt-icon">local_shipping</mat-icon>
        <div class="prompt-content">
          <h4>Commencez à ajouter des livraisons</h4>
          <p *ngIf="trajectMode === 'new'">Définissez les points de livraison pour votre trajet</p>
          <p *ngIf="trajectMode === 'predefined' && selectedTraject">Ajoutez les livraisons pour ce traject</p>
          <p *ngIf="trajectMode === 'predefined' && !selectedTraject">Sélectionnez d'abord un traject prédéfini</p>
        </div>
        <button 
          mat-raised-button 
          color="primary" 
          type="button" 
          (click)="addDelivery()"
          class="add-first-delivery-btn"
          [disabled]="trajectMode === 'predefined' && !selectedTraject"
        >
          <mat-icon>add</mat-icon>
          Ajouter une livraison
        </button>
      </div>
    </div>

    <!-- Section des livraisons (only shown when there are deliveries) -->
    <div class="deliveries-section" formArrayName="deliveries" *ngIf="showDeliveriesSection">
      <div class="section-header">
        <h3>Livraisons</h3>
        <div class="section-header-actions">
          <p class="text-sm text-gray-500">
            {{ deliveries.length }} livraison(s) ajoutée(s)
          </p>
          <button type="button"
            mat-stroked-button 
            type="button" 
            (click)="addDelivery()"
            class="add-delivery-top-btn"
          >
            <mat-icon>add</mat-icon>
            Ajouter une livraison
          </button>
        </div>
      </div>
      
      <!-- Simple Delivery Form Fields -->
      <div class="simple-deliveries" *ngIf="deliveries.length > 0">
        <div *ngFor="let deliveryGroup of deliveryControls; let i = index"
            [formGroupName]="i"
            class="simple-delivery-card">
          
          <div class="delivery-card-header">
            <div class="delivery-title">
              <mat-icon class="delivery-icon">local_shipping</mat-icon>
              <h4>Livraison {{ i + 1 }}</h4>
            </div>
            <div class="delivery-actions">
              <span class="sequence-badge">#{{ deliveryGroup.get('sequence')?.value }}</span>
              <button 
                mat-icon-button 
                type="button" 
                (click)="removeDelivery(i)"
                *ngIf="deliveries.length > 1"
                class="remove-delivery-btn"
                matTooltip="Supprimer cette livraison"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="delivery-form-grid">
            <!-- Client Selection -->
            <div class="form-group">
              <label class="form-label">Client *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <mat-select formControlName="customerId" (selectionChange)="onCustomerChange(i)" placeholder="Sélectionner un client">
                  <mat-option *ngFor="let customer of customers" [value]="customer.id">
                    <div class="client-option-simple">
                      <div class="client-name">{{ customer.name }}</div>
                      <div *ngIf="customer.matricule" class="client-matricule">
                        {{ customer.matricule }}
                      </div>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deliveryGroup.get('customerId')?.hasError('required')">
                  La sélection d'un client est obligatoire
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Order Selection -->
            <div class="form-group">
              <label class="form-label">Commande *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <mat-select formControlName="orderId" placeholder="Sélectionner une commande">
                  <mat-option *ngFor="let order of getCustomerOrders(i)" [value]="order.id">
                    <div class="order-option">
                      <div class="order-ref">{{ order.reference }}</div>
                      <div class="order-details">
                        <span class="order-type">{{ order.type || 'Non spécifié' }}</span>
                        <span class="order-weight">{{ order.weight }} kg</span>
                      </div>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="deliveryGroup.get('orderId')?.hasError('required')">
                  La sélection d'une commande est obligatoire
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Order Preview Card -->
            <div class="order-preview-card" *ngIf="deliveryGroup.get('orderId')?.value">
              <div class="preview-header">
                <mat-icon>info</mat-icon>
                <span>Détails de la commande</span>
              </div>
              <div class="preview-content">
                <div class="preview-row">
                  <span class="preview-label">Référence:</span>
                  <span class="preview-value">{{ getOrderReference(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Type:</span>
                  <span class="preview-value">{{ getOrderType(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Poids:</span>
                  <span class="preview-value">{{ getOrderWeight(deliveryGroup.get('orderId')?.value) }} kg</span>
                </div>
              </div>
            </div>

            <!-- Delivery Address -->
            <div class="form-group full-width">
              <label class="form-label">Adresse de livraison *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="deliveryAddress"
                  placeholder="Ex: Rue de la Paix, 75001 Paris"
                  rows="2"
                ></textarea>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('required')">
                  L'adresse de livraison est obligatoire
                </mat-error>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('maxlength')">
                  Maximum 500 caractères
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Sequence and Time -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="form-label">Ordre de livraison</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="number"
                    formControlName="sequence"
                    min="1"
                    [max]="deliveries.length"
                    placeholder="Ex: 1"
                  />
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('required')">
                    L'ordre de livraison est obligatoire
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('min')">
                    L'ordre doit être au moins 1
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('max')">
                    L'ordre ne peut pas dépasser {{ deliveries.length }}
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-group">
                <label class="form-label">Heure prévue</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="time"
                    formControlName="plannedTime"
                    placeholder="HH:MM"
                  />
                </mat-form-field>
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group full-width">
              <label class="form-label">Notes (optionnel)</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="notes"
                  placeholder="Informations supplémentaires..."
                  rows="2"
                ></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline Summary Section with Drag & Drop (Only for new traject mode) -->
      <div class="timeline-summary" *ngIf="shouldShowTimelineSummary()" [class.loading]="isDragging">
        <div class="summary-header">
          <div class="summary-title">
            <h4>Récapitulatif du trajet</h4>
            <div class="drag-instructions" *ngIf="deliveries.length > 1">
              <mat-icon class="drag-icon">drag_indicator</mat-icon>
              <span>Glissez-déposez les livraisons pour réorganiser</span>
            </div>
            <div class="timeline-actions" *ngIf="deliveries.length > 0">
              <button mat-button color="primary" (click)="autoCalculatePlannedTimes()" *ngIf="deliveries.length > 1">
                <mat-icon>schedule</mat-icon>
                Calculer les heures
              </button>
              <button mat-button color="warn" (click)="resetSequences()" *ngIf="deliveries.length > 1">
                <mat-icon>restart_alt</mat-icon>
                Réinitialiser l'ordre
              </button>
            </div>
          </div>
          <div class="trip-id-badge">
            <mat-icon>route</mat-icon>
            <span>#{{ tripForm.get('tripReference')?.value || 'Nouveau' }}</span>
          </div>
        </div>
        
        <div class="divider-line">
          <div class="divider-icon">
            <mat-icon>arrow_downward</mat-icon>
          </div>
        </div>
        
        <!-- Drag and Drop Container -->
        <div class="timeline-flow" cdkDropList 
             (cdkDropListDropped)="drop($event)">
          
          <!-- Start Point -->
          <div class="timeline-step start-step">
            <div class="step-marker">
              <mat-icon>play_arrow</mat-icon>
            </div>
            <div class="step-content">
              <div class="step-header">
                <div class="step-title">Départ</div>
                <div class="step-badge start-badge">Démarrage</div>
              </div>
              <div class="step-details">
                <div class="detail-item">
                  <mat-icon class="detail-icon calendar_today">calendar_today</mat-icon>
                  <div class="detail-text">
                    <strong>Date:</strong> {{ formatDateForDisplay(tripForm.get('estimatedStartDate')?.value) || 'Non définie' }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon local_shipping">local_shipping</mat-icon>
                  <div class="detail-text">
                    <strong>Camion:</strong> {{ getSelectedTruckInfo() }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon person">person</mat-icon>
                  <div class="detail-text">
                    <strong>Chauffeur:</strong> {{ getSelectedDriverInfo() }}
                  </div>
                </div>
                <div class="detail-item" *ngIf="tripForm.get('estimatedStartDate')?.value">
                  <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                  <div class="detail-text">
                    <strong>Heure départ:</strong> 08:00
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Delivery Points -->
          <div class="delivery-steps">
            <ng-container *ngFor="let deliveryGroup of deliveryControls; let i = index; let last = last">
              <div [class]="getDeliveryStepClass(i, deliveryGroup)"
                   cdkDrag
                   [cdkDragData]="i"
                   (cdkDragStarted)="onDragStarted()"
                   (cdkDragEnded)="onDragEnded()">
                
                <!-- Drag handle -->
                <div class="drag-handle" cdkDragHandle *ngIf="deliveries.length > 1">
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                
                <div class="step-connector">
                  <div class="connector-line"></div>
                  <div class="connector-arrow">
                    <mat-icon>arrow_downward</mat-icon>
                  </div>
                  <div class="connector-label">
                    <span class="drag-hint" *ngIf="deliveries.length > 1">
                      <mat-icon>open_with</mat-icon>
                    </span>
                  </div>
                </div>
                
                <div class="step-marker" [ngStyle]="getStepMarkerStyle(deliveryGroup)">
                  <span class="delivery-number" [class.updated]="isSequenceUpdated(i)">
                    {{ i + 1 }}
                  </span>
                </div>
                
                <div class="step-content">
                  <div class="step-header">
                    <div class="step-title">Livraison {{ i + 1 }}</div>
                    <div class="step-badge delivery-badge" [style.background]="getDeliveryStatusColor(deliveryGroup)">
                      {{ getDeliveryStatus(deliveryGroup) }}
                    </div>
                  </div>
                  <div class="step-details">
                    <!-- Client -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon client-icon">person</mat-icon>
                      <div class="detail-text">
                        <strong>Client:</strong> 
                        <span [style.color]="deliveryGroup.get('customerId')?.value ? '#1f2937' : '#ef4444'">
                          {{ getClientName(deliveryGroup.get('customerId')?.value) || 'Non sélectionné' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Order -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon order-icon">inventory</mat-icon>
                      <div class="detail-text">
                        <strong>Commande:</strong>
                        <span [style.color]="deliveryGroup.get('orderId')?.value ? '#1f2937' : '#ef4444'">
                          {{ getOrderReference(deliveryGroup.get('orderId')?.value) || 'Non sélectionnée' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Address -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon address-icon">location_on</mat-icon>
                      <div class="detail-text address-preview">
                        <strong>Adresse:</strong>
                        <span [style.color]="deliveryGroup.get('deliveryAddress')?.value?.length > 5 ? '#6b7280' : '#ef4444'">
                          {{ deliveryGroup.get('deliveryAddress')?.value || 'Non définie' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Planned Time -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                      <div class="detail-text">
                        <strong>Heure prévue:</strong>
                        <span [style.color]="deliveryGroup.get('plannedTime')?.value ? '#1f2937' : '#94a3b8'">
                          {{ deliveryGroup.get('plannedTime')?.value || calculateDeliveryTime(i + 1) }}
                          <span *ngIf="!deliveryGroup.get('plannedTime')?.value" class="time-hint">
                            (estimée)
                          </span>
                        </span>
                      </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="detail-item" *ngIf="deliveryGroup.get('notes')?.value">
                      <mat-icon class="detail-icon notes-icon">note</mat-icon>
                      <div class="detail-text notes-preview">
                        <strong>Notes:</strong> {{ deliveryGroup.get('notes')?.value | slice:0:50 }}
                        {{ deliveryGroup.get('notes')?.value?.length > 50 ? '...' : '' }}
                      </div>
                    </div>
                    
                    <!-- Sequence Info -->
                    <div class="detail-item sequence-info">
                      <mat-icon class="detail-icon sequence-icon">sort</mat-icon>
                      <div class="detail-text">
                        <strong>Ordre:</strong> {{ deliveryGroup.get('sequence')?.value || i + 1 }}
                        <span class="sequence-change" *ngIf="hasSequenceChanged(i, deliveryGroup)">
                          (Changé)
                        </span>
                      </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="detail-item delivery-actions">
                      <button mat-icon-button color="primary" (click)="editDelivery(i)" matTooltip="Modifier">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" (click)="removeDelivery(i)" matTooltip="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>

          <!-- End Point -->
          <div class="timeline-step end-step">
            <div class="step-connector">
              <div class="connector-line"></div>
              <div class="connector-arrow">
                <mat-icon>arrow_downward</mat-icon>
              </div>
              <div class="connector-label">Fin</div>
            </div>
            
            <div class="step-marker">
              <mat-icon>flag</mat-icon>
            </div>
            
            <div class="step-content">
              <div class="step-header">
                <div class="step-title">Arrivée</div>
                <div class="step-badge end-badge">Final</div>
              </div>
              <div class="step-details">
                <div class="detail-item">
                  <mat-icon class="detail-icon calendar_today">calendar_today</mat-icon>
                  <div class="detail-text">
                    <strong>Date:</strong> {{ formatDateForDisplay(tripForm.get('estimatedEndDate')?.value) || 'Non définie' }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon trending_up">trending_up</mat-icon>
                  <div class="detail-text">
                    <strong>Distance:</strong> {{ tripForm.get('estimatedDistance')?.value || 0 }} km
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon timer">timer</mat-icon>
                  <div class="detail-text">
                    <strong>Durée:</strong> {{ tripForm.get('estimatedDuration')?.value || 0 }}h
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon speed">speed</mat-icon>
                  <div class="detail-text">
                    <strong>Vitesse moy.:</strong> {{ calculateAverageSpeed() }} km/h
                  </div>
                </div>
                <div class="detail-item" *ngIf="tripForm.get('estimatedEndDate')?.value">
                  <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                  <div class="detail-text">
                    <strong>Heure arrivée:</strong> {{ calculateArrivalTime() }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="timeline-stats">
          <div class="stat-card total-distance">
            <mat-icon>directions_car</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ tripForm.get('estimatedDistance')?.value || 0 }} km</div>
              <div class="stat-label">Distance totale</div>
            </div>
          </div>
          
          <div class="stat-card total-duration">
            <mat-icon>schedule</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ tripForm.get('estimatedDuration')?.value || 0 }}h</div>
              <div class="stat-label">Durée estimée</div>
            </div>
          </div>
          
          <div class="stat-card delivery-count">
            <mat-icon>local_shipping</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ deliveries.length }}</div>
              <div class="stat-label">Livraisons</div>
              <div class="stat-subtext" *ngIf="getCompletedDeliveriesCount() > 0">
                {{ getCompletedDeliveriesCount() }} complète(s)
              </div>
            </div>
          </div>
          
          <div class="stat-card status-indicator" [class]="tripForm.get('tripStatus')?.value || 'Planned'">
            <mat-icon>flag</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ getTripStatusLabel(tripForm.get('tripStatus')?.value) }}</div>
              <div class="stat-label">Statut</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-footer">
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="tripForm.invalid || deliveries.length === 0 || loading || (saveAsTraject && !trajectName.trim())"
      >
        <span *ngIf="loading">Envoi en cours...</span>
        <span *ngIf="!loading">{{ data.tripId ? 'Enregistrer' : 'Créer le voyage' }}</span>
      </button>
      <button mat-button type="button" (click)="onCancel()" [disabled]="loading">Annuler</button>
    </div>
  </form>
</mat-card>