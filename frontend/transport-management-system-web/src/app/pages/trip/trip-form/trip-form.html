<mat-card class="trip-form-card">
  <header class="trip-form-card__header">
    <div>
      <h2>{{ data.tripId ? 'Modifier voyage' : 'Ajouter voyage' }}</h2>
    </div>
  </header>

  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <span>Chargement...</span>
  </div>

  <form [formGroup]="tripForm" (ngSubmit)="onSubmit()">
          <div *ngIf="trajectMode === 'new'" class="location-section">
        <div class="section-header">
          <h3>Lieux du voyage</h3>
        </div>
        
        <div class="location-grid">
          <!-- Start Location -->
          <mat-form-field appearance="outline" class="location-field">
            <mat-select formControlName="startLocationId" placeholder="Sélectionner un lieu de départ">
              <mat-option *ngFor="let location of activeLocations" [value]="location.id">
                <div class="location-option">
                  <span class="location-name">{{ location.name }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="tripForm.get('startLocationId')?.hasError('required')">
              Le lieu de départ est obligatoire
            </mat-error>
            <mat-error *ngIf="tripForm.get('startLocationId')?.hasError('sameLocation')">
              Le lieu de départ et d'arrivée doivent être différents
            </mat-error>
          </mat-form-field>

          <!-- End Location -->
          <mat-form-field appearance="outline" class="location-field">
            <mat-select formControlName="endLocationId" placeholder="Sélectionner un lieu d'arrivée">
              <mat-option *ngFor="let location of activeLocations" [value]="location.id">
                <div class="location-option">
                  <span class="location-name">{{ location.name }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="tripForm.get('endLocationId')?.hasError('required')">
              Le lieu d'arrivée est obligatoire
            </mat-error>
            <mat-error *ngIf="tripForm.get('endLocationId')?.hasError('sameLocation')">
              Le lieu d'arrivée doit être différent du lieu de départ
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Arrival equals departure checkbox -->
        <div class="same-location-checkbox">
          <mat-checkbox [formControl]="arrivalEqualsDeparture" color="primary">
            Le lieu d'arrivée est le même que le lieu de départ
          </mat-checkbox>
          <mat-icon class="checkbox-info-icon" matTooltip="Cochez cette case si le camion retourne à son point de départ">info</mat-icon>
        </div>

        <!-- Location Preview -->
        <div class="location-preview" *ngIf="tripForm.get('startLocationId')?.value || tripForm.get('endLocationId')?.value">
          <div class="preview-line">
            <div class="preview-point start">
              <mat-icon>place</mat-icon>
              <span>{{ getSelectedStartLocationInfo() }}</span>
            </div>
            
            <mat-icon class="arrow-icon">arrow_forward</mat-icon>
            
            <div class="preview-point end" [class.same-location]="arrivalEqualsDeparture.value">
              <mat-icon>{{ arrivalEqualsDeparture.value ? 'place' : 'flag' }}</mat-icon>
              <span>{{ arrivalEqualsDeparture.value ? 'Même lieu' : getSelectedEndLocationInfo() }}</span>
            </div>
          </div>
          
          <div *ngIf="arrivalEqualsDeparture.value" class="same-location-note">
            <mat-icon>info</mat-icon>
            <span>Le camion retourne à son point de départ après les livraisons</span>
          </div>
        </div>
      </div>

<div class="weather-section" *ngIf="shouldShowWeather()">
  <div class="section-header">
    <h3>
      <mat-icon>cloud</mat-icon>
      Conditions météorologiques
    </h3>
    <div class="weather-actions">
      <button mat-button type="button" (click)="refreshWeather()" [disabled]="weatherLoading">
        <mat-icon>refresh</mat-icon>
        Actualiser
      </button>
      <button mat-button type="button" (click)="toggleWeatherForecast()">
        <mat-icon>{{ showWeatherForecast ? 'visibility_off' : 'calendar_today' }}</mat-icon>
        {{ showWeatherForecast ? 'Masquer prévisions' : 'Prévisions' }}
      </button>
    </div>
  </div>

  
  <div class="weather-loading" *ngIf="weatherLoading">
    <mat-spinner diameter="30"></mat-spinner>
    <span>Chargement des données météo...</span>
  </div>

 
  <div class="weather-cards" *ngIf="!weatherLoading">
  
    <div class="weather-card" *ngIf="startLocationWeather">
      <div class="weather-card-header">
        <h4>
          <mat-icon class="location-icon">place</mat-icon>
          Départ: {{ getSelectedStartLocationInfo() }}
        </h4>
        <div class="weather-timestamp">
          <mat-icon>schedule</mat-icon>
          Mis à jour à {{ getCurrentTime }}
        </div>
      </div>
      
      <div class="weather-main-info">
        <div class="weather-icon-temp">
          <img [src]="startLocationWeather.icon" 
               [alt]="startLocationWeather.description" 
               class="weather-icon">
          <div class="temperature-display">
            <span class="temperature-value">{{ startLocationWeather.temperature }}°C</span>
            <span class="feels-like">Ressenti: {{ startLocationWeather.feels_like }}°C</span>
          </div>
        </div>
        
        <div class="weather-details">
        
          <div class="weather-description">
            {{ startLocationWeather.description | titlecase }}
          </div>
          
          <div class="weather-stats">
            <div class="weather-stat">
              <mat-icon>water_drop</mat-icon>
              <span>Humidité: {{ startLocationWeather.humidity }}%</span>
            </div>
            <div class="weather-stat">
              <mat-icon>air</mat-icon>
              <span>Vent: {{ startLocationWeather.wind_speed }} km/h</span>
            </div>
            <div class="weather-stat" *ngIf="startLocationWeather.precipitation && startLocationWeather.precipitation > 0">
              <mat-icon>rainy</mat-icon>
              <span>Précipitation: {{ startLocationWeather.precipitation | number:'1.1-1' }} mm</span>
            </div>
          </div>
        </div>
      </div>
    </div>

   
    <div class="weather-card" *ngIf="endLocationWeather">
      <div class="weather-card-header">
        <h4>
          <mat-icon class="location-icon">flag</mat-icon>
          Arrivée: {{ getSelectedEndLocationInfo() }}
        </h4>
        <div class="weather-timestamp">
          <mat-icon>schedule</mat-icon>
          Mis à jour à {{ getCurrentTime }}
        </div>
      </div>
      
      <div class="weather-main-info">
        <div class="weather-icon-temp">
          <img [src]="endLocationWeather.icon" 
               [alt]="endLocationWeather.description" 
               class="weather-icon">
          <div class="temperature-display">
            <span class="temperature-value">{{ endLocationWeather.temperature }}°C</span>
            <span class="feels-like">Ressenti: {{ endLocationWeather.feels_like }}°C</span>
          </div>
        </div>
        
        <div class="weather-details">
          <div class="weather-description">
            {{ endLocationWeather.description | titlecase }}
          </div>
          
          <div class="weather-stats">
            <div class="weather-stat">
              <mat-icon>water_drop</mat-icon>
              <span>Humidité: {{ endLocationWeather.humidity }}%</span>
            </div>
            <div class="weather-stat">
              <mat-icon>air</mat-icon>
              <span>Vent: {{ endLocationWeather.wind_speed }} km/h</span>
            </div>
            <div class="weather-stat" *ngIf="endLocationWeather.precipitation && endLocationWeather.precipitation > 0">
              <mat-icon>rainy</mat-icon>
              <span>Précipitation: {{ endLocationWeather.precipitation | number:'1.1-1' }} mm</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="weather-forecast-section" *ngIf="showWeatherForecast && (startLocationForecast.length > 0 || endLocationForecast.length > 0)">
    <h4>Prévisions sur 5 jours</h4>
    
    <div class="forecast-container">
     
      <div class="location-forecast" *ngIf="startLocationForecast.length > 0">
        <h5>Départ: {{ getSelectedStartLocationInfo() }}</h5>
        <div class="forecast-days">
          <div class="forecast-day" *ngFor="let day of startLocationForecast">
            <div class="forecast-day-name">{{ day.day }}</div>
            <div class="forecast-day-date">{{ day.date | date:'dd/MM' }}</div>
            <mat-icon>{{ getWeatherIconClass(day.icon) }}</mat-icon>
            <div class="forecast-temp">
              <span class="temp-max">{{ day.temperature_max }}°</span>
              <span class="temp-min">{{ day.temperature_min }}°</span>
            </div>
            <div class="forecast-desc">{{ day.description }}</div>
            <div class="forecast-precipitation" *ngIf="day.precipitation_chance > 0">
              <mat-icon>water_drop</mat-icon>
              <span>{{ (day.precipitation_chance * 100) | number:'1.0-0' }}%</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- End Location Forecast -->
      <div class="location-forecast" *ngIf="endLocationForecast.length > 0">
        <h5>Arrivée: {{ getSelectedEndLocationInfo() }}</h5>
        <div class="forecast-days">
          <div class="forecast-day" *ngFor="let day of endLocationForecast">
            <div class="forecast-day-name">{{ day.day }}</div>
            <div class="forecast-day-date">{{ day.date | date:'dd/MM' }}</div>
            <mat-icon>{{ getWeatherIconClass(day.icon) }}</mat-icon>
            <div class="forecast-temp">
              <span class="temp-max">{{ day.temperature_max }}°</span>
              <span class="temp-min">{{ day.temperature_min }}°</span>
            </div>
            <div class="forecast-desc">{{ day.description }}</div>
            <div class="forecast-precipitation" *ngIf="day.precipitation_chance > 0">
              <mat-icon>water_drop</mat-icon>
              <span>{{ (day.precipitation_chance * 100) | number:'1.0-0' }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Weather Warning -->
  <div class="weather-warning" *ngIf="shouldShowWeatherWarning()">
    <mat-icon color="warn">warning</mat-icon>
    <div class="warning-content">
      <strong>Alerte météo:</strong> Conditions difficiles prévues sur le trajet. Vérifiez les prévisions avant de partir.
    </div>
  </div>
</div>

<!-- Weather Prompt (when locations are selected but weather not loaded) -->
<div class="weather-prompt" *ngIf="!shouldShowWeather() && (tripForm.get('startLocationId')?.value || tripForm.get('endLocationId')?.value)">
  <mat-icon>cloud_queue</mat-icon>
  <div class="prompt-content">
    <p>Charger les conditions météo pour le trajet ?</p>
    <button mat-button type="button" color="primary" (click)="fetchWeatherForBothLocations()" [disabled]="weatherLoading">
      <mat-icon>cloud_download</mat-icon>
      Charger la météo
    </button>
  </div>
</div>

<!-- Weather Prompt (when locations are selected but weather not loaded) -->
<div class="weather-prompt" *ngIf="!shouldShowWeather() && (tripForm.get('startLocationId')?.value || tripForm.get('endLocationId')?.value)">
  <mat-icon>cloud_queue</mat-icon>
  <div class="prompt-content">
    <p>Charger les conditions météo pour le trajet ?</p>
    <button mat-button type="button" color="primary" (click)="fetchWeatherForBothLocations()" [disabled]="weatherLoading">
      <mat-icon>cloud_download</mat-icon>
      Charger la météo
    </button>
  </div>
</div>
    <!-- Progression du voyage -->
    <div class="status-workflow-section" *ngIf="data.tripId">
      <div class="section-header">
        <h3>Progression du voyage</h3>
        <div class="status-indicator">
          <mat-icon class="status-icon">info</mat-icon>
          <span class="status-text">
            Statut actuel: <strong>{{ getTripStatusLabel(tripForm.get('tripStatus')?.value) }}</strong>
          </span>
        </div>
      </div>

<!-- Status Progress Bar -->
<div class="status-progress-bar">
  <div class="progress-steps">
    <!-- Step 1: Planned -->
    <div class="progress-step" 
         [class.active]="tripForm.get('tripStatus')?.value === 'Planned'"
         [class.completed]="isStatusCompleted('Planned')">
      <div class="step-circle">
        <span class="step-number">1</span>
        <mat-icon *ngIf="isStatusCompleted('Planned')" class="step-check">check</mat-icon>
      </div>
      <div class="step-label">
        <span>Planifié</span>
        <small *ngIf="tripForm.get('tripStatus')?.value === 'Planned'" class="current-badge">En cours</small>
      </div>
    </div>

    <div class="progress-connector" [class.active]="isStatusCompleted('Planned')"></div>

    <!-- Step 2: Accepted -->
    <div class="progress-step" 
         [class.active]="tripForm.get('tripStatus')?.value === 'Accepted'"
         [class.completed]="isStatusCompleted('Accepted')">
      <div class="step-circle">
        <span class="step-number">2</span>
        <mat-icon *ngIf="isStatusCompleted('Accepted')" class="step-check">check</mat-icon>
      </div>
      <div class="step-label">
        <span>Accepté</span>
        <small *ngIf="tripForm.get('tripStatus')?.value === 'Accepted'" class="current-badge">En cours</small>
      </div>
    </div>

    <div class="progress-connector" [class.active]="isStatusCompleted('Accepted')"></div>


<div class="progress-connector" [class.active]="isStatusCompleted('Loading')"></div>

    <div class="progress-connector" [class.active]="isStatusCompleted('Loading')"></div>

    <!-- Step 4: LoadingInProgress -->
    <div class="progress-step" 
         [class.active]="tripForm.get('tripStatus')?.value === 'LoadingInProgress'"
         [class.completed]="isStatusCompleted('LoadingInProgress')">
      <div class="step-circle">
        <span class="step-number">4</span>
        <mat-icon *ngIf="isStatusCompleted('LoadingInProgress')" class="step-check">check</mat-icon>
      </div>
      <div class="step-label">
        <span>Chargement<br>en cours</span>
        <small *ngIf="tripForm.get('tripStatus')?.value === 'LoadingInProgress'" class="current-badge">En cours</small>
      </div>
    </div>

    <div class="progress-connector" [class.active]="isStatusCompleted('LoadingInProgress')"></div>


    <div class="progress-connector" [class.active]="isStatusCompleted('Delivery')"></div>

    <!-- Step 6: DeliveryInProgress -->
    <div class="progress-step" 
         [class.active]="tripForm.get('tripStatus')?.value === 'DeliveryInProgress'"
         [class.completed]="isStatusCompleted('DeliveryInProgress')">
      <div class="step-circle">
        <span class="step-number">6</span>
        <mat-icon *ngIf="isStatusCompleted('DeliveryInProgress')" class="step-check">check</mat-icon>
      </div>
      <div class="step-label">
        <span>Livraison<br>en cours</span>
        <small *ngIf="tripForm.get('tripStatus')?.value === 'DeliveryInProgress'" class="current-badge">En cours</small>
      </div>
    </div>

    <div class="progress-connector" [class.active]="isStatusCompleted('DeliveryInProgress')"></div>

    <!-- Step 7: Completed -->
    <div class="progress-step" 
         [class.active]="tripForm.get('tripStatus')?.value === 'Completed'"
         [class.completed]="isStatusCompleted('Completed')">
      <div class="step-circle">
        <span class="step-number">7</span>
        <mat-icon *ngIf="isStatusCompleted('Completed')" class="step-check">check</mat-icon>
      </div>
      <div class="step-label">
        <span>Livrée</span>
        <small *ngIf="tripForm.get('tripStatus')?.value === 'Completed'" class="current-badge">Terminé</small>
      </div>
    </div>
  </div>
</div>
    </div>

    <!-- Dates estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de début estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedStartDatePicker"
          formControlName="estimatedStartDate"
          placeholder="Date de début estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedStartDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedStartDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedStartDate')?.hasError('required')">
          La date de début estimée est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de fin estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedEndDatePicker"
          formControlName="estimatedEndDate"
          placeholder="Date de fin estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedEndDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedEndDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedEndDate')?.hasError('required')">
          La date de fin estimée est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Camion & Chauffeur -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Camion</mat-label>
        <mat-select formControlName="truckId" placeholder="Sélectionner un camion">
          <mat-option *ngFor="let truck of trucks" [value]="truck.id">
            {{ truck.immatriculation }} - {{ truck.brand }}
            <span class="text-gray-500 text-sm ml-2">
              (Capacité: {{ truck.capacity }} tonne)
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('truckId')?.hasError('required')">
          La sélection d'un camion est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Chauffeur *</mat-label>
        
        <mat-select
          formControlName="driverId"
          placeholder="Sélectionner un chauffeur"
          [disabled]="loadingDrivers || loadingAvailableDrivers">

          <mat-select-trigger>
            <span class="driver-name">
              {{ getDriverNameById(tripForm.get('driverId')?.value) }}
            </span>
            <mat-icon class="available-icon" color="primary">check_circle</mat-icon>
          </mat-select-trigger>

          <mat-option *ngFor="let driver of availableDrivers" [value]="driver.id">
            <div class="driver-option">
              <span class="driver-name">{{ driver.name }}</span>
              <mat-icon class="available-icon" color="primary">check_circle</mat-icon>
            </div>
          </mat-option>
            
          <mat-option 
            *ngIf="data.tripId && tripForm.get('driverId')?.value && !isCurrentDriverInAvailableList()"
            [value]="tripForm.get('driverId')?.value">
            <div class="driver-option current-driver">
              <span class="driver-name">
                {{ getCurrentDriverName() }}
              </span>
              <span class="driver-permis">{{ getCurrentDriverPermis() }}</span>
              <mat-icon class="current-driver-icon" color="warn">warning</mat-icon>
              <span class="driver-warning">(Affecté à ce voyage)</span>
            </div>
          </mat-option>
          
          <!-- Message si aucun chauffeur disponible -->
          <mat-option *ngIf="availableDrivers.length === 0 && !loadingAvailableDrivers" disabled>
            <div class="no-driver-available">
              <mat-icon>warning</mat-icon>
              <span>Aucun chauffeur disponible pour cette date</span>
            </div>
          </mat-option>
          
          <!-- Option de chargement -->
          <mat-option *ngIf="loadingAvailableDrivers" disabled>
            <div class="loading-option">
              <mat-spinner diameter="20"></mat-spinner>
              <span>Chargement des chauffeurs...</span>
            </div>
          </mat-option>
        </mat-select>
        
        <mat-hint *ngIf="loadingAvailableDrivers">
          <div class="loading-hint">
            <mat-spinner diameter="16"></mat-spinner>
            Vérification des disponibilités...
          </div>
        </mat-hint>
        
        <mat-hint *ngIf="!loadingAvailableDrivers && tripForm.get('estimatedStartDate')?.value">
          <div class="availability-info">
            <mat-icon>info</mat-icon>
            <span>{{ availableDrivers.length }} disponible(s)</span>
            <span *ngIf="data.tripId && tripForm.get('driverId')?.value" class="current-driver-hint">
              • Chauffeur actuel: {{ getCurrentDriverName() }}
            </span>
          </div>
        </mat-hint>
        
        <mat-error *ngIf="tripForm.get('driverId')?.hasError('required')">
          La sélection d'un chauffeur est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Distance & Durée estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Distance estimée (km)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDistance"
          min="0.1"
          step="0.1"
          placeholder="Ex: 150.5"
          (blur)="onDistanceBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('required')">
          La distance estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('min')">
          La distance doit être au moins 0.1 km
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Durée estimée (heures)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDuration"
          min="0.1"
          step="0.1"
          placeholder="Ex: 3.5"
          (blur)="onDurationBlur()"
        />
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('required')">
          La durée estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('min')">
          La durée doit être au moins 0.1 heure
        </mat-error>
      </mat-form-field>
    </div>

    <div class="trip-row">
      <!-- Statut -->
      <mat-form-field appearance="outline" class="trip-field trip-field--wide">
        <mat-label>Statut du voyage</mat-label>
        <mat-select formControlName="tripStatus" placeholder="Sélectionner un statut">
          <mat-option *ngFor="let status of tripStatuses" [value]="status.value">
            {{ status.label }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('tripStatus')?.hasError('required')">
          Le statut du voyage est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Convoyeur</mat-label>
        <mat-select formControlName="convoyeurId" placeholder="Sélectionner un convoyeur (optionnel)">
          <mat-option [value]="null">
            -- Aucun convoyeur --
          </mat-option>
          <mat-option *ngFor="let convoyeur of convoyeurs" [value]="convoyeur.id">
            {{ convoyeur.name }}
          </mat-option>
        </mat-select>
        <mat-hint>Optionnel - pour les transports spéciaux ou longs trajets</mat-hint>
      </mat-form-field>
    </div>

    <!-- Capacity Section -->
    <div class="capacity-section" *ngIf="tripForm.get('truckId')?.value">
      <div class="capacity-header">
        <div class="capacity-info">
          <mat-icon>local_shipping</mat-icon>
          <div class="capacity-details">
            <h4>Capacité du camion</h4>
            <p class="capacity-stats">
              {{ calculateTotalWeight() }} tonne / {{ getSelectedTruckCapacity() }} tonne
              <span class="capacity-percentage">
                ({{ calculateCapacityPercentage() | number:'1.0-0' }}%)
              </span>
            </p>
          </div>
        </div>
        
        <!-- Afficher l'alerte si nécessaire -->
        <div *ngIf="calculateCapacityPercentage() >= 90" 
             class="capacity-alert"
             [ngStyle]="{'background': getCapacityAlert().color + '20'}">
          <mat-icon [color]="getCapacityAlert().color">
            {{ getCapacityAlert().icon }}
          </mat-icon>
          <span [style.color]="getCapacityAlert().color">
            {{ getCapacityAlert().message }}
          </span>
        </div>
      </div>
      
      <!-- Barre de progression -->
      <div class="capacity-progress">
        <div class="progress-bar">
          <div class="progress-fill"
               [style.width.%]="calculateCapacityPercentage()"
               [style.background]="getProgressBarColor()">
          </div>
          
          <!-- Marqueurs de seuil -->
          <div class="threshold-marker" style="left: 70%">
            <div class="threshold-dot" style="background: #3b82f6"></div>
            <span class="threshold-label">70%</span>
          </div>
          
          <div class="threshold-marker" style="left: 90%">
            <div class="threshold-dot" style="background: #f59e0b"></div>
            <span class="threshold-label">90%</span>
          </div>
          
          <div class="threshold-marker" style="left: 100%">
            <div class="threshold-dot" style="background: #ef4444"></div>
            <span class="threshold-label">Max</span>
          </div>
        </div>
        
        <!-- Légende des couleurs -->
        <div class="progress-legend">
          <div class="legend-item">
            <span class="legend-color" style="background: #10b981"></span>
            <span>Normal</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #3b82f6"></span>
            <span>Élevé</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #f59e0b"></span>
            <span>Attention</span>
          </div>
          <div class="legend-item">
            <span class="legend-color" style="background: #ef4444"></span>
            <span>Dépassé</span>
          </div>
        </div>
      </div>
      
      <!-- Détails des livraisons -->
      <div class="capacity-breakdown" *ngIf="deliveries.length > 0">
        <h5>Détail du chargement</h5>
        <div class="delivery-items">
          <div *ngFor="let deliveryGroup of deliveryControls; let i = index" 
               class="delivery-item">
            <div class="item-index">#{{ i + 1 }}</div>
            <div class="item-details">
              <span class="item-client">{{ getClientName(deliveryGroup.get('customerId')?.value) }}</span>
              <span class="item-weight">
                {{ getOrderWeight(deliveryGroup.get('orderId')?.value) }} tonne
              </span>
            </div>
            <div class="item-percentage">
              {{ calculateDeliveryPercentage(i) | number:'1.0-0' }}%
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Traject Configuration -->
    <div class="traject-section" *ngIf="!data.tripId">
      <div class="section-header">
        <div>
          <h3>Configuration du Trajet</h3>
          <p class="text-sm text-gray-500">
            Choisissez entre un itinéraire prédéfini ou créez-en un nouveau à partir des livraisons
          </p>
        </div>
      </div>

      <!-- Choice between predefined or new traject -->
      <div class="traject-choice">
        <mat-radio-group [(ngModel)]="trajectMode" (change)="onTrajectModeChange()" name="trajectMode" [ngModelOptions]="{standalone: true}">
          <div class="radio-option">
            <mat-radio-button value="predefined">
              <div class="option-content">
                <mat-icon class="option-icon">route</mat-icon>
                <div class="option-text">
                  <div class="option-title">Utiliser un traject prédéfini</div>
                  <div class="option-description">Sélectionnez un itinéraire standard enregistré</div>
                </div>
              </div>
            </mat-radio-button>
          </div>
          
          <div class="radio-option">
            <mat-radio-button value="new">
              <div class="option-content">
                <mat-icon class="option-icon">add_road</mat-icon>
                <div class="option-text">
                  <div class="option-title">Créer un nouveau trajet</div>
                  <div class="option-description">Définissez le trajet à partir des points de livraison</div>
                </div>
              </div>
            </mat-radio-button>
          </div>
        </mat-radio-group>
      </div>

      <!-- Predefined Traject Selection --> 
      <div *ngIf="trajectMode === 'predefined'">
        <div class="traject-selection-section">
          <div class="selection-header">
            <div>
              <h4>Sélection du traject prédéfini</h4>
              <p class="text-sm text-gray-500">Choisissez un itinéraire standard</p>
            </div>
          </div>
          
          <div class="traject-selection">
            <mat-form-field appearance="outline" class="traject-field full-width">
              <mat-select
                [formControl]="selectedTrajectControl"
                (selectionChange)="onTrajectSelected($event.value)"
                [disabled]="loadingTrajects"
              >
                <mat-option [value]="null">-- Aucun --</mat-option>
                <mat-option *ngFor="let traject of trajects" [value]="traject.id">
                  <div class="traject-option">
                    <div class="traject-name">{{ traject.name }}</div>
                    <div class="traject-info">
                      <span class="traject-points">
                        <mat-icon class="icon-small">location_on</mat-icon>
                        {{ traject.points?.length || 0 }} points
                      </span>
                      <span class="traject-status" [class.predefined]="traject.isPredefined">
                        {{ traject.isPredefined ? 'Standard' : 'Personnalisé' }}
                      </span>
                    </div>
                  </div>
                </mat-option>
              </mat-select>
              <mat-hint>Sélectionnez un traject pour pré-remplir les estimations</mat-hint>
            </mat-form-field>
            
        
            <div *ngIf="loadingTrajects" class="loading-trajects">
              <mat-spinner diameter="30"></mat-spinner>
              <span>Chargement des trajects...</span>
            </div>
          </div>
        </div>
      </div>

      

      <!-- Save as Traject Option (only for new traject mode) -->
     <div *ngIf="trajectMode === 'new' && deliveries.length > 0" class="save-traject-section">
  <div class="save-header">
    <mat-checkbox 
      [(ngModel)]="saveAsPredefined"
      (change)="onSaveAsPredefinedChange($event.checked)"
      [ngModelOptions]="{standalone: true}"
      color="primary"
    >
      Définir comme traject standard (réutilisable)
    </mat-checkbox>
    <mat-icon class="info-icon" 
              matTooltip="Ce traject sera disponible dans la liste des trajects prédéfinis">
      info
    </mat-icon>
  </div>
  
  <div *ngIf="saveAsPredefined" class="traject-config-options">
    <div class="traject-name-input">
      <mat-form-field appearance="outline" class="full-width">
        <input
          matInput
          [(ngModel)]="trajectName"
          placeholder="Ex: Paris-Lyon-Marseille"
          maxlength="100"
          required
          [ngModelOptions]="{standalone: true}"
        />
        <mat-error *ngIf="!trajectName && saveAsPredefined">
          Le nom du traject est obligatoire
        </mat-error>
        <mat-hint>{{ trajectName?.length || 0 }}/100 caractères</mat-hint>
      </mat-form-field>
      
      <div class="traject-preview-from-deliveries">
        <div class="preview-title">
          <mat-icon>visibility</mat-icon>
          <span>Aperçu du traject à enregistrer</span>
        </div>
        <div class="preview-points">
          <div *ngFor="let deliveryGroup of deliveryControls; let i = index" class="preview-point">
            <div class="preview-order">{{ i + 1 }}</div>
            <div class="preview-address">{{ deliveryGroup.get('deliveryAddress')?.value || 'Adresse non définie' }}</div>
            <div class="preview-client" *ngIf="deliveryGroup.get('customerId')?.value">
              <mat-icon>person</mat-icon>
              {{ getClientName(deliveryGroup.get('customerId')?.value) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
    </div>

    <!-- Selected Traject Preview (for both new and edit modes) -->
    <div class="selected-traject-preview" *ngIf="selectedTraject">
      <div class="preview-header">
        <div class="preview-title">
          <h4>Traject sélectionné</h4>
          <div class="traject-name-actions">
            <span class="traject-badge">{{ selectedTraject.name }}</span>
            <span class="traject-status-badge" [class.predefined]="selectedTraject.isPredefined">
              {{ selectedTraject.isPredefined ? 'Standard' : 'Personnalisé' }}
            </span>
          </div>
        </div>
        
        <div class="preview-actions">
          
         <div *ngIf="data.tripId && !selectedTraject.isPredefined" class="save-as-predefined-section">
          <mat-checkbox 
            [(ngModel)]="saveAsPredefined"
            (change)="onSaveAsPredefinedChange($event.checked)"
            [ngModelOptions]="{standalone: true}"
            color="primary"
          >
            Définir comme traject standard
          </mat-checkbox>
          <mat-icon 
            class="info-icon" 
            matTooltip="Ce traject sera enregistré comme standard pour être réutilisé dans d'autres voyages"
          >
            info
          </mat-icon>
        </div>
          
          <!-- Display status if already predefined -->
          <div *ngIf="selectedTraject.isPredefined" class="predefined-status-display">
            <mat-icon color="primary" class="predefined-icon">check_circle</mat-icon>
            <span class="predefined-text">Traject standard (réutilisable)</span>
          </div>
          
          <!-- Traject actions -->
          <div class="traject-actions">
            <button mat-button type="button" 
                    (click)="changeTraject()"
                    class="change-traject-btn">
              <mat-icon>swap_horiz</mat-icon>
              Changer de traject
            </button>
            
            <button mat-button type="button" 
                    (click)="deleteTraject()"
                    class="delete-traject-btn"
                    color="warn"
                    [disabled]="savingTrajectChanges || deletingTraject">
              <mat-icon *ngIf="!deletingTraject">delete</mat-icon>
              <mat-spinner *ngIf="deletingTraject" diameter="20"></mat-spinner>
              {{ deletingTraject ? 'Suppression...' : 'Supprimer' }}
            </button>
          </div>
        </div>
      </div>
      
      <!-- Traject details -->
      <div class="traject-details">
        <div class="detail-row">
          <div class="detail-item">
            <mat-icon class="detail-icon">pin_drop</mat-icon>
            <div class="detail-content">
              <div class="detail-label">Points d'arrêt</div>
              <div class="detail-value">{{ selectedTraject.points?.length || 0 }} points</div>
            </div>
          </div>
          
          <div class="detail-item">
            <mat-icon class="detail-icon">route</mat-icon>
            <div class="detail-content">
              <div class="detail-label">Type de traject</div>
              <div class="detail-value" [class.predefined]="selectedTraject.isPredefined">
                {{ selectedTraject.isPredefined ? 'Standard' : 'Personnalisé' }}
              </div>
            </div>
          </div>
          
          <div class="detail-item">
            <mat-icon class="detail-icon">calendar_today</mat-icon>
            <div class="detail-content">
              <div class="detail-label">Créé le</div>
              <div class="detail-value">{{ formatTrajectDate(selectedTraject.createdAt) }}</div> 
            </div>
          </div>
        </div>
        
        <!-- Warning message if not predefined -->
        <div *ngIf="!selectedTraject.isPredefined && data.tripId" class="traject-warning">
          <mat-icon class="warning-icon">warning</mat-icon>
          <div class="warning-content">
            <div class="warning-title">Traject personnalisé</div>
            <div class="warning-text">
              Ce traject n'est pas enregistré comme standard. Cochez la case ci-dessus pour le définir comme standard et le réutiliser.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Add Section -->
    <div class="quick-add-title" *ngIf="filteredClients.length > 0 && trajectMode === 'new'">
      <h3>Ajout rapide de commandes</h3>
      <p class="text-sm text-gray-500">
        <span class="counter-highlight">{{ filteredClients.length }}</span> 
        clients avec commandes en attente
        <span *ngIf="clientSearchControl.value" class="filter-info">
          ({{ allClientsWithPendingOrders.length }} total)
        </span>
      </p>
    </div>

    <div class="quick-add-section" *ngIf="filteredClients.length > 0 && trajectMode === 'new'">
      <div class="section-header">
        <!-- Step Indicator -->
        <div class="quick-add-step-indicator">
          <div class="step" [class.active]="currentQuickAddStep === 1">
            <div class="step-number">1</div>
            <span>Sélection du client</span>
          </div>
          <div class="step-separator"></div>
          <div class="step" [class.active]="currentQuickAddStep === 2">
            <div class="step-number">2</div>
            <span>Sélection des commandes</span>
          </div>
          <div class="step-separator"></div>
          <div class="step" [class.active]="currentQuickAddStep === 3">
            <div class="step-number">3</div>
            <span>Confirmation</span>
          </div>
        </div>
      </div>

      <!-- Step 1: Client Selection -->
      <div *ngIf="currentQuickAddStep === 1" class="client-selection-step">
        <div class="search-box">
          <mat-form-field appearance="outline" class="search-field full-width">
            <input
              matInput
              [formControl]="clientSearchControl"
              placeholder="Rechercher un client par nom ou matricule..."
            >
            <button
              matSuffix
              mat-icon-button
              *ngIf="clientSearchControl.value"
              (click)="clearClientSearch()"
              type="button"
              aria-label="Effacer la recherche"
            >
              <mat-icon>close</mat-icon>
            </button>
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>
        </div>

        <!-- Client Cards Grid -->
        <div class="client-grid">
          <!-- Show each client from displayedClients -->
          <div *ngFor="let client of displayedClients" 
               class="client-card"
               (click)="selectClientForQuickAdd(client)"
               [class.selected]="selectedClient?.id === client.id">
            
            <div class="client-card-header">
              <div class="client-name">{{ client.name }}</div>
              <div *ngIf="client.matricule" class="client-matricule">
                {{ client.matricule }}
              </div>
            </div>
            
            <div class="client-card-content">
              <div class="client-orders-count">
                <mat-icon class="order-icon">inventory_2</mat-icon>
                <span>{{ getClientPendingOrdersCount(client.id) }} commande(s)</span>
              </div>
              <div class="client-total-weight">
                <mat-icon class="weight-icon">scale</mat-icon>
                <span>{{ getClientTotalWeight(client.id).toFixed(2) }} tonne</span>
              </div>
            </div>
            
            <div class="client-card-footer">
              <div class="client-address" *ngIf="client.adress">
                {{ client.adress | slice:0:50 }}{{ client.adress.length > 50 ? '...' : '' }}
              </div>
              <button type="button" mat-icon-button 
                      class="client-select-btn"
                      (click)="selectClientForQuickAdd(client); $event.stopPropagation()">
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <!-- Show More/Less Controls -->
        <div class="client-display-controls" *ngIf="filteredClients.length > clientsToShowCount">
          <div class="controls-container">
            <!-- Show count indicator -->
            <div class="client-count-indicator">
              <mat-icon>people</mat-icon>
              <span>
                Affichage de 
                <strong>{{ displayedClients.length }}</strong> sur 
                <strong>{{ filteredClients.length }}</strong> clients
              </span>
            </div>
            
            <!-- Show More/Less Button -->
            <button type="button" mat-button 
                    class="show-more-less-btn"
                    (click)="toggleClientsDisplay()"
                    [class.showing-less]="!showAllClients"
                    [class.showing-more]="showAllClients">
              <mat-icon>{{ showAllClients ? 'expand_less' : 'expand_more' }}</mat-icon>
              <span>{{ showAllClients ? 'Voir moins' : 'Voir plus' }}</span>
              <span class="remaining-count" *ngIf="!showAllClients">
                (+{{ filteredClients.length - clientsToShowCount }} autres)
              </span>
            </button>
          </div>
          
          <!-- Progress indicator (optional) -->
          <div class="progress-indicator" *ngIf="shouldShowMoreButton">
            <div class="progress-bar">
              <div class="progress-fill" 
                   [style.width.%]="(displayedClients.length / filteredClients.length) * 100">
              </div>
            </div>
            <span class="progress-text">
              {{ Math.round((displayedClients.length / filteredClients.length) * 100) }}% affichés
            </span>
          </div>
        </div>

        <!-- No results message -->
        <div *ngIf="filteredClients.length === 0 && clientSearchControl.value" class="no-results">
          <mat-icon class="no-results-icon">search_off</mat-icon>
          <h4>Aucun client trouvé</h4>
          <p>Aucun client ne correspond à "{{ clientSearchControl.value }}"</p>
          <button mat-button type="button" (click)="clearClientSearch()" class="clear-filter-btn">
            <mat-icon>clear_all</mat-icon>
            Effacer la recherche
          </button>
        </div>

        <!-- Empty state when no clients at all -->
        <div *ngIf="filteredClients.length === 0 && !clientSearchControl.value" class="no-clients-empty">
          <mat-icon class="empty-icon">person_off</mat-icon>
          <h4>Aucun client avec des commandes en attente</h4>
          <p>Tous les clients ont leurs commandes déjà traitées ou aucune commande en attente.</p>
        </div>
      </div>

      <!-- Step 2: Order Selection -->
      <div *ngIf="currentQuickAddStep === 2 && selectedClient" class="order-selection-step">
        <div class="selected-client-header">
          <button type="button" mat-button (click)="goBackToClientSelection()" class="back-btn">
            <mat-icon>arrow_back</mat-icon>
            Retour aux clients
          </button>
          <div class="client-info">
            <div class="client-name-display">{{ selectedClient.name }}</div>
            <div class="client-details">
              <span *ngIf="selectedClient.matricule">{{ selectedClient.matricule }}</span>
              <span>{{ getClientPendingOrdersCount(selectedClient.id) }} commandes en attente</span>
            </div>
          </div>
        </div>
        
        <!-- Order Selection Controls -->
        <div class="order-selection-controls">
          <div class="selection-summary">
            <div class="summary-item">
              <mat-icon>check_circle</mat-icon>
              <span>{{ selectedOrdersCount }} / {{ clientPendingOrders.length }} sélectionnées</span>
            </div>
            <div class="summary-item">
              <mat-icon>scale</mat-icon>
              <span>{{ calculateSelectedWeight() }} tonne</span>
            </div>
          </div>
          
          <div class="selection-actions">
            <button type="button" mat-button (click)="selectAllOrders()">
              <mat-icon>select_all</mat-icon>
              Tout sélectionner
            </button>
            <button type="button" mat-button (click)="deselectAllOrders()">
              <mat-icon>deselect</mat-icon>
              Tout désélectionner
            </button>
          </div>
        </div>
        
        <!-- Orders Grid/List -->
        <div class="orders-container">
          <div *ngFor="let order of clientPendingOrders" 
               class="order-item"
               [class.selected]="isOrderSelected(order.id)"
               (click)="toggleOrderSelection(order)">
            
            <div class="order-select-checkbox">
              <mat-checkbox [checked]="isOrderSelected(order.id)"
                           (click)="$event.stopPropagation(); toggleOrderSelection(order)">
              </mat-checkbox>
            </div>
            
            <div class="order-details">
              <div class="order-ref">{{ order.reference }}</div>
              <div class="order-type">{{ order.type || 'Standard' }}</div>
              <div class="order-weight">{{ order.weight }} tonne</div>
            </div>
            
            <div class="order-date">
              <mat-icon class="date-icon">calendar_today</mat-icon>
              <span>{{ order.createdDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            
            <div class="order-actions">
              <button type="button" mat-icon-button 
                      class="order-preview-btn"
                      (click)="previewOrder(order); $event.stopPropagation()">
                <mat-icon>visibility</mat-icon>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Add to Trip Button -->
        <div class="add-orders-footer">
          <div class="selected-orders-summary">
            <mat-icon>shopping_cart</mat-icon>
            <span><strong>{{ selectedOrdersCount }}</strong> commandes sélectionnées</span>
            <span class="total-weight">({{ calculateSelectedWeight() }} tonne)</span>
          </div>
          <button type="button" mat-raised-button color="primary"
                  (click)="confirmAddOrders()"
                  [disabled]="selectedOrdersCount === 0">
            <mat-icon>add</mat-icon>
            Ajouter au voyage
          </button>
        </div>
      </div>

      <!-- Step 3: Confirmation -->
      <div *ngIf="currentQuickAddStep === 3" class="confirmation-step">
        <div class="confirmation-header">
          <mat-icon class="success-icon">check_circle</mat-icon>
          <h4>Commandes ajoutées avec succès !</h4>
          <p>{{ lastAddedOrdersCount }} commande(s) ont été ajoutées au voyage</p>
        </div>
        
        <div class="added-orders-summary">
          <div class="summary-card">
            <div class="summary-title">Récapitulatif</div>
            <div class="summary-details">
              <div class="summary-item">
                <span class="label">Client:</span>
                <span class="value">{{ selectedClient?.name }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Commandes ajoutées:</span>
                <span class="value">{{ lastAddedOrdersCount }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Poids total:</span>
                <span class="value">{{ calculateSelectedWeight() }} tonne</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="confirmation-actions">
          <button type="button" mat-button 
                  (click)="goBackToClientSelection()"
                  class="add-more-btn">
            <mat-icon>add</mat-icon>
            Ajouter d'autres commandes
          </button>
          <button type="button" mat-raised-button color="primary"
                  (click)="finishQuickAdd()">
            <mat-icon>done</mat-icon>
            Terminer
          </button>
        </div>
      </div>
    </div>

    <!-- Add delivery button (always visible when traject mode is selected) -->
    <div class="add-delivery-button-section" *ngIf="trajectMode !== null && (!showDeliveriesSection || deliveries.length === 0)">
      <div class="add-delivery-prompt">
        <mat-icon class="prompt-icon">local_shipping</mat-icon>
        <div class="prompt-content">
          <h4>Commencez à ajouter des livraisons</h4>
          <p *ngIf="trajectMode === 'new'">Définissez les points de livraison pour votre trajet</p>
          <p *ngIf="trajectMode === 'predefined' && selectedTraject">Ajoutez les livraisons pour ce traject</p>
          <p *ngIf="trajectMode === 'predefined' && !selectedTraject">Sélectionnez d'abord un traject prédéfini</p>
        </div>
        <button 
          mat-raised-button 
          color="primary" 
          type="button" 
          (click)="addDelivery()"
          class="add-first-delivery-btn"
          [disabled]="trajectMode === 'predefined' && !selectedTraject"
        >
          <mat-icon>add</mat-icon>
          Ajouter une livraison
        </button>
      </div>
    </div>

    <!-- Section des livraisons (only shown when there are deliveries) -->
    <div class="deliveries-section" formArrayName="deliveries" *ngIf="showDeliveriesSection">
      <div class="section-header">
        <h3>Livraisons</h3>
        <div class="section-header-actions">
          <p class="text-sm text-gray-500">
            {{ deliveries.length }} livraison(s) ajoutée(s)
          </p>
          <button type="button"
            mat-stroked-button 
            type="button" 
            (click)="addDelivery()"
            class="add-delivery-top-btn"
          >
            <mat-icon>add</mat-icon>
            Ajouter une livraison
          </button>
        </div>
      </div>
      
      <!-- Simple Delivery Form Fields -->
      <div class="simple-deliveries" *ngIf="deliveries.length > 0">
        <div *ngFor="let deliveryGroup of deliveryControls; let i = index"
            [formGroupName]="i"
            class="simple-delivery-card">
          
          <div class="delivery-card-header">
            <div class="delivery-title">
              <mat-icon class="delivery-icon">local_shipping</mat-icon>
              <h4>Livraison {{ i + 1 }}</h4>
            </div>
            <div class="delivery-actions">
              <span class="sequence-badge">#{{ deliveryGroup.get('sequence')?.value }}</span>
              <button 
                mat-icon-button 
                type="button" 
                (click)="removeDelivery(i)"
                *ngIf="deliveries.length > 1"
                class="remove-delivery-btn"
                matTooltip="Supprimer cette livraison"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          
          <div class="delivery-form-grid">
          <mat-form-field appearance="outline" class="delivery-field">
  <mat-label>Client *</mat-label>
  <mat-select formControlName="customerId" (selectionChange)="onCustomerChange(i)" placeholder="Sélectionner un client">
    
    <!-- Search input inside dropdown -->
    <div class="dropdown-search-container">
      <input 
        type="text" 
        class="dropdown-search-input"
        placeholder="Rechercher client..."
        (input)="filterDropdown('client', i, $event)"
        (click)="$event.stopPropagation()"
      >
      <mat-icon class="dropdown-search-icon">search</mat-icon>
    </div>
    
    <mat-optgroup>
      <!-- Filtered customers -->
      <mat-option *ngFor="let customer of getFilteredCustomers(i)" [value]="customer.id">
        <div class="client-option-simple">
          <div class="client-name">{{ customer.name }}</div>
          <div *ngIf="customer.matricule" class="client-matricule">
            {{ customer.matricule }}
          </div>
        </div>
      </mat-option>
      
      <!-- No results -->
      <mat-option *ngIf="getFilteredCustomers(i).length === 0" disabled>
        <div class="no-results">
          <mat-icon>search_off</mat-icon>
          <span>Aucun client trouvé</span>
        </div>
      </mat-option>
    </mat-optgroup>
    
  </mat-select>
  <mat-error *ngIf="deliveryGroup.get('customerId')?.hasError('required')">
    La sélection d'un client est obligatoire
  </mat-error>
</mat-form-field>

            <!-- Order Selection -->
          
             <mat-form-field appearance="outline" class="delivery-field">
  <mat-label>Commande *</mat-label>
  <mat-select formControlName="orderId" placeholder="Sélectionner une commande">
    
    <!-- Search input inside dropdown -->
    <div class="dropdown-search-container">
      <input 
        type="text" 
        class="dropdown-search-input"
        placeholder="Rechercher commande..."
        (input)="filterDropdown('order', i, $event)"
        (click)="$event.stopPropagation()"
      >
      <mat-icon class="dropdown-search-icon">search</mat-icon>
    </div>
    
    <mat-optgroup>
      <!-- Filtered orders -->
      <mat-option *ngFor="let order of getFilteredOrders(i)" [value]="order.id">
        <div class="order-option">
          <div class="order-ref">{{ order.reference }}</div>
          <div class="order-details">
            <span class="order-type">{{ order.type || 'Non spécifié' }}</span>
            <span class="order-weight">{{ order.weight }} tonne</span>
          </div>
          <div class="order-date">
            <mat-icon class="date-icon">calendar_today</mat-icon>
            <span>{{ order.createdDate | date:'dd MMM yyyy' }}</span>
          </div>
        </div>
      </mat-option>
      
      <!-- No results -->
      <mat-option *ngIf="getFilteredOrders(i).length === 0" disabled>
        <div class="no-results">
          <mat-icon>search_off</mat-icon>
          <span>Aucune commande trouvée</span>
        </div>
      </mat-option>
    </mat-optgroup>
    
  </mat-select>
  <mat-error *ngIf="deliveryGroup.get('orderId')?.hasError('required')">
    La sélection d'une commande est obligatoire
  </mat-error>
</mat-form-field>
           

            <!-- Order Preview Card -->
            <div class="order-preview-card" *ngIf="deliveryGroup.get('orderId')?.value">
              <div class="preview-header">
                <mat-icon>info</mat-icon>
                <span>Détails de la commande</span>
              </div>
              <div class="preview-content">
                <div class="preview-row">
                  <span class="preview-label">Référence:</span>
                  <span class="preview-value">{{ getOrderReference(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Type:</span>
                  <span class="preview-value">{{ getOrderType(deliveryGroup.get('orderId')?.value) }}</span>
                </div>
                <div class="preview-row">
                  <span class="preview-label">Poids:</span>
                  <span class="preview-value">{{ getOrderWeight(deliveryGroup.get('orderId')?.value) }} tonne</span>
                </div>
              </div>
            </div>

            <!-- Delivery Address -->
            <div class="form-group full-width">
              <label class="form-label">Adresse de livraison *</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="deliveryAddress"
                  placeholder="Ex: Rue de la Paix, 75001 Paris"
                  rows="2"
                ></textarea>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('required')">
                  L'adresse de livraison est obligatoire
                </mat-error>
                <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('maxlength')">
                  Maximum 500 caractères
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Sequence and Time -->
            <div class="form-group-row">
              <div class="form-group">
                <label class="form-label">Ordre de livraison</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="number"
                    formControlName="sequence"
                    min="1"
                    [max]="deliveries.length"
                    placeholder="Ex: 1"
                  />
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('required')">
                    L'ordre de livraison est obligatoire
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('min')">
                    L'ordre doit être au moins 1
                  </mat-error>
                  <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('max')">
                    L'ordre ne peut pas dépasser {{ deliveries.length }}
                  </mat-error>
                </mat-form-field>
              </div>

              <div class="form-group">
                <label class="form-label">Heure prévue</label>
                <mat-form-field appearance="outline" class="delivery-field">
                  <input
                    matInput
                    type="time"
                    formControlName="plannedTime"
                    placeholder="HH:MM"
                  />
                </mat-form-field>
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group full-width">
              <label class="form-labels">Notes (optionnel)</label>
              <mat-form-field appearance="outline" class="delivery-field">
                <textarea
                  matInput
                  formControlName="notes"
                  placeholder="Informations supplémentaires..."
                  rows="2"
                ></textarea>
              </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline Summary Section with Drag & Drop (Only for new traject mode) -->
      <div class="timeline-summary" *ngIf="shouldShowTimelineSummary()" [class.loading]="isDragging">
        <div class="summary-header">
          <div class="summary-title">
            <h4>Récapitulatif du trajet</h4>
            <div class="drag-instructions" *ngIf="deliveries.length > 1">
              <mat-icon class="drag-icon">drag_indicator</mat-icon>
              <span>Glissez-déposez les livraisons pour réorganiser</span>
            </div>
            <div class="timeline-actions" *ngIf="deliveries.length > 0">
              <button mat-button type="button" color="primary" (click)="autoCalculatePlannedTimes()" *ngIf="deliveries.length > 1">
                <mat-icon>schedule</mat-icon>
                Calculer les heures
              </button>
              <button mat-button type="button"color="warn" (click)="resetSequences()" *ngIf="deliveries.length > 1">
                <mat-icon>restart_alt</mat-icon>
                Réinitialiser l'ordre
              </button>
            </div>
          </div>
          <div class="trip-id-badge">
            <mat-icon>route</mat-icon>
            <span>#{{ tripForm.get('tripReference')?.value || 'Nouveau' }}</span>
          </div>
        </div>
        
        <div class="divider-line">
          <div class="divider-icon">
            <mat-icon>arrow_downward</mat-icon>
          </div>
        </div>
        
        <!-- Drag and Drop Container -->
        <div class="timeline-flow" cdkDropList 
             (cdkDropListDropped)="drop($event)">
          
          <!-- Start Point -->
          <div class="timeline-step start-step">
            <div class="step-marker">
              <mat-icon>play_arrow</mat-icon>
            </div>
            <div class="step-content">
              <div class="step-header">
                <div class="step-title">Départ</div>
                <div class="step-badge start-badge">Démarrage</div>
              </div>
              <div class="step-details">
                <div class="detail-item">
                  <mat-icon class="detail-icon location-icon">place</mat-icon>
                  <div class="detail-text">
                    <strong>Lieu:</strong> {{ getSelectedStartLocationInfo() }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon calendar_today">calendar_today</mat-icon>
                  <div class="detail-text">
                    <strong>Date:</strong> {{ formatDateForDisplay(tripForm.get('estimatedStartDate')?.value) || 'Non définie' }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon local_shipping">local_shipping</mat-icon>
                  <div class="detail-text">
                    <strong>Camion:</strong> {{ getSelectedTruckInfo() }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon person">person</mat-icon>
                  <div class="detail-text">
                    <strong>Chauffeur:</strong> {{ getSelectedDriverInfo() }}
                  </div>
                </div>
                <div class="detail-item" *ngIf="tripForm.get('estimatedStartDate')?.value">
                  <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                  <div class="detail-text">
                    <strong>Heure départ:</strong> 08:00
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Delivery Points -->
          <div class="delivery-steps">
            <ng-container *ngFor="let deliveryGroup of deliveryControls; let i = index; let last = last">
              <div [class]="getDeliveryStepClass(i, deliveryGroup)"
                   cdkDrag
                   [cdkDragData]="i"
                   (cdkDragStarted)="onDragStarted()"
                   (cdkDragEnded)="onDragEnded()">
                
                <!-- Drag handle -->
                <div class="drag-handle" cdkDragHandle *ngIf="deliveries.length > 1">
                  <mat-icon>drag_indicator</mat-icon>
                </div>
                
                <div class="step-connector">
                  <div class="connector-line"></div>
                  <div class="connector-arrow">
                    <mat-icon>arrow_downward</mat-icon>
                  </div>
                  <div class="connector-label">
                    <span class="drag-hint" *ngIf="deliveries.length > 1">
                      <mat-icon>open_with</mat-icon>
                    </span>
                  </div>
                </div>
                
                <div class="step-marker" [ngStyle]="getStepMarkerStyle(deliveryGroup)">
                  <span class="delivery-number" [class.updated]="isSequenceUpdated(i)">
                    {{ i + 1 }}
                  </span>
                </div>
                
                <div class="step-content">
                  <div class="step-header">
                    <div class="step-title">Livraison {{ i + 1 }}</div>
                    <div class="step-badge delivery-badge" [style.background]="getDeliveryStatusColor(deliveryGroup)">
                      {{ getDeliveryStatus(deliveryGroup) }}
                    </div>
                  </div>
                  <div class="step-details">
                    <!-- Client -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon client-icon">person</mat-icon>
                      <div class="detail-text">
                        <strong>Client:</strong> 
                        <span [style.color]="deliveryGroup.get('customerId')?.value ? '#1f2937' : '#ef4444'">
                          {{ getClientName(deliveryGroup.get('customerId')?.value) || 'Non sélectionné' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Order -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon order-icon">inventory</mat-icon>
                      <div class="detail-text">
                        <strong>Commande:</strong>
                        <span [style.color]="deliveryGroup.get('orderId')?.value ? '#1f2937' : '#ef4444'">
                          {{ getOrderReference(deliveryGroup.get('orderId')?.value) || 'Non sélectionnée' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Address -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon address-icon">location_on</mat-icon>
                      <div class="detail-text address-preview">
                        <strong>Adresse:</strong>
                        <span [style.color]="deliveryGroup.get('deliveryAddress')?.value?.length > 5 ? '#6b7280' : '#ef4444'">
                          {{ deliveryGroup.get('deliveryAddress')?.value || 'Non définie' }}
                        </span>
                      </div>
                    </div>
                    
                    <!-- Planned Time -->
                    <div class="detail-item">
                      <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                      <div class="detail-text">
                        <strong>Heure prévue:</strong>
                        <span [style.color]="deliveryGroup.get('plannedTime')?.value ? '#1f2937' : '#94a3b8'">
                          {{ deliveryGroup.get('plannedTime')?.value || calculateDeliveryTime(i + 1) }}
                          <span *ngIf="!deliveryGroup.get('plannedTime')?.value" class="time-hint">
                            (estimée)
                          </span>
                        </span>
                      </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="detail-item" *ngIf="deliveryGroup.get('notes')?.value">
                      <mat-icon class="detail-icon notes-icon">note</mat-icon>
                      <div class="detail-text notes-preview">
                        <strong>Notes:</strong> {{ deliveryGroup.get('notes')?.value | slice:0:50 }}
                        {{ deliveryGroup.get('notes')?.value?.length > 50 ? '...' : '' }}
                      </div>
                    </div>
                    
                    <!-- Sequence Info -->
                    <div class="detail-item sequence-info">
                      <mat-icon class="detail-icon sequence-icon">sort</mat-icon>
                      <div class="detail-text">
                        <strong>Ordre:</strong> {{ deliveryGroup.get('sequence')?.value || i + 1 }}
                        <span class="sequence-change" *ngIf="hasSequenceChanged(i, deliveryGroup)">
                          (Changé)
                        </span>
                      </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="detail-item delivery-actions">
                      <button mat-icon-button color="primary" (click)="editDelivery(i)" matTooltip="Modifier">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" (click)="removeDelivery(i)" matTooltip="Supprimer">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>

          <!-- End Point -->
          <div class="timeline-step end-step">
            <div class="step-connector">
              <div class="connector-line"></div>
              <div class="connector-arrow">
                <mat-icon>arrow_downward</mat-icon>
              </div>
              <div class="connector-label">Fin</div>
            </div>
            
            <div class="step-marker">
              <mat-icon>flag</mat-icon>
            </div>
            
            <div class="step-content">
              <div class="step-header">
                <div class="step-title">Arrivée</div>
                <div class="step-badge end-badge">Final</div>
              </div>
              <div class="step-details">
                <div class="detail-item">
                  <mat-icon class="detail-icon location-icon">place</mat-icon>
                  <div class="detail-text">
                    <strong>Lieu:</strong> {{ getSelectedEndLocationInfo() }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon calendar_today">calendar_today</mat-icon>
                  <div class="detail-text">
                    <strong>Date:</strong> {{ formatDateForDisplay(tripForm.get('estimatedEndDate')?.value) || 'Non définie' }}
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon trending_up">trending_up</mat-icon>
                  <div class="detail-text">
                    <strong>Distance:</strong> {{ tripForm.get('estimatedDistance')?.value || 0 }} km
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon timer">timer</mat-icon>
                  <div class="detail-text">
                    <strong>Durée:</strong> {{ tripForm.get('estimatedDuration')?.value || 0 }}h
                  </div>
                </div>
                <div class="detail-item">
                  <mat-icon class="detail-icon speed">speed</mat-icon>
                  <div class="detail-text">
                    <strong>Vitesse moy.:</strong> {{ calculateAverageSpeed() }} km/h
                  </div>
                </div>
                <div class="detail-item" *ngIf="tripForm.get('estimatedEndDate')?.value">
                  <mat-icon class="detail-icon time-icon">schedule</mat-icon>
                  <div class="detail-text">
                    <strong>Heure arrivée:</strong> {{ calculateArrivalTime() }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="timeline-stats">
          <div class="stat-card total-distance">
            <mat-icon>directions_car</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ tripForm.get('estimatedDistance')?.value || 0 }} km</div>
              <div class="stat-label">Distance totale</div>
            </div>
          </div>
          
          <div class="stat-card total-duration">
            <mat-icon>schedule</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ tripForm.get('estimatedDuration')?.value || 0 }}h</div>
              <div class="stat-label">Durée estimée</div>
            </div>
          </div>
          
          <div class="stat-card delivery-count">
            <mat-icon>local_shipping</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ deliveries.length }}</div>
              <div class="stat-label">Livraisons</div>
              <div class="stat-subtext" *ngIf="getCompletedDeliveriesCount() > 0">
                {{ getCompletedDeliveriesCount() }} complète(s)
              </div>
            </div>
          </div>
          
          <div class="stat-card status-indicator" [class]="tripForm.get('tripStatus')?.value || 'Planned'">
            <mat-icon>flag</mat-icon>
            <div class="stat-content">
              <div class="stat-value">{{ getTripStatusLabel(tripForm.get('tripStatus')?.value) }}</div>
              <div class="stat-label">Statut</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Information pour voyage annulé -->
    <div class="cancelled-info" *ngIf="tripForm.get('tripStatus')?.value === 'Cancelled'">
      <mat-icon class="cancelled-icon">cancel</mat-icon>
      <div class="cancelled-text">
        <h4>Voyage annulé</h4>
        <p>Ce voyage a été annulé et ne peut plus être modifié.</p>
      </div>
    </div>

    <!-- Actions de workflow -->
<div class="workflow-actions-footer" *ngIf="data.tripId && tripForm.get('tripStatus')?.value !== 'Completed' && tripForm.get('tripStatus')?.value !== 'Cancelled'">
  <div class="workflow-action-buttons">
    <button type="button" mat-stroked-button color="warn" 
            (click)="cancelTrip()"
            class="cancel-trip-btn">
      <mat-icon>cancel</mat-icon>
      Annuler le voyage
    </button>
    
    <button type="button" mat-raised-button color="primary" 
            (click)="advanceStatus()"
            [disabled]="!canAdvanceStatus()"
            class="advance-status-btn">
      <mat-icon>arrow_forward</mat-icon>
      Passer à l'étape suivante
    </button>
  </div>
  
  <div class="status-notes">
    <mat-icon>info</mat-icon>
    <span *ngIf="tripForm.get('tripStatus')?.value === 'Planned'">
      Remplissez toutes les informations requises pour accepter le voyage.
    </span>
    <span *ngIf="tripForm.get('tripStatus')?.value === 'LoadingInProgress'">
      Vérifiez que toutes les marchandises sont correctement chargées avant de passer à la livraison.
    </span>
    <span *ngIf="tripForm.get('tripStatus')?.value === 'DeliveryInProgress'">
      Assurez-vous que toutes les livraisons sont complétées avant de finaliser le voyage.
    </span>
  </div>
</div>

    <!-- Footer simplifié -->
    <div class="form-footer-simple">
      <button mat-button type="button" (click)="onCancel()" [disabled]="loading" class="cancel-btn">
        Annuler
      </button>
      
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="tripForm.invalid || deliveries.length === 0 || loading || (saveAsPredefined && !trajectName.trim())"
        class="save-btn"
      >
        <mat-icon *ngIf="loading" class="loading-icon">hourglass_empty</mat-icon>
        <span>{{ data.tripId ? 'Enregistrer' : 'Créer le voyage' }}</span>
      </button>
    </div>
  </form>
</mat-card>