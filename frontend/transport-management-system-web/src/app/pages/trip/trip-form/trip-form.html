<mat-card class="trip-form-card">
  <header class="trip-form-card__header">
    <div>
      <h2>{{ data.tripId ? 'Modifier voyage' : 'Ajouter voyage' }}</h2>
    </div>
  </header>

  <form [formGroup]="tripForm" (ngSubmit)="onSubmit()">
    <!-- Référence du trajet -->
    <mat-form-field appearance="outline" class="trip-field trip-field--wide">
      <mat-label>Référence du voyage</mat-label>
      <input
        matInput
        formControlName="tripReference"
        placeholder="Ex: LIV-2024-001"
      />
      <mat-error *ngIf="tripForm.get('tripReference')?.hasError('required')">
        La référence du voyage est obligatoire
      </mat-error>
    </mat-form-field>

    <!-- Dates estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de début estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedStartDatePicker"
          formControlName="estimatedStartDate"
          placeholder="Date de début estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedStartDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedStartDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedStartDate')?.hasError('required')">
          La date de début estimée est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Date de fin estimée</mat-label>
        <input
          matInput
          [matDatepicker]="estimatedEndDatePicker"
          formControlName="estimatedEndDate"
          placeholder="Date de fin estimée"
        />
        <mat-datepicker-toggle matSuffix [for]="estimatedEndDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #estimatedEndDatePicker></mat-datepicker>
        <mat-error *ngIf="tripForm.get('estimatedEndDate')?.hasError('required')">
          La date de fin estimée est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Camion & Chauffeur -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Camion</mat-label>
        <mat-select formControlName="truckId" placeholder="Sélectionner un camion">
          <mat-option *ngFor="let truck of trucks" [value]="truck.id">
            {{ truck.immatriculation }} - {{ truck.brand }}
            <span class="text-gray-500 text-sm ml-2">
              (Capacité: {{ truck.capacity }} kg)
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('truckId')?.hasError('required')">
          La sélection d'un camion est obligatoire
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Chauffeur</mat-label>
        <mat-select formControlName="driverId" placeholder="Sélectionner un chauffeur">
          <mat-option *ngFor="let driver of drivers" [value]="driver.id">
            {{ driver.name }}
            <span class="text-gray-500 text-sm ml-2">
              ({{ driver.permisNumber }})
            </span>
          </mat-option>
        </mat-select>
        <mat-error *ngIf="tripForm.get('driverId')?.hasError('required')">
          La sélection d'un chauffeur est obligatoire
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Distance & Durée estimées -->
    <div class="trip-row">
      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Distance estimée (km)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDistance"
          min="0"
          step="0.1"
          placeholder="Ex: 150.5"
        />
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('required')">
          La distance estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDistance')?.hasError('min')">
          La distance doit être positive
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="trip-field">
        <mat-label>Durée estimée (heures)</mat-label>
        <input
          matInput
          type="number"
          formControlName="estimatedDuration"
          min="0"
          step="0.1"
          placeholder="Ex: 3.5"
        />
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('required')">
          La durée estimée est obligatoire
        </mat-error>
        <mat-error *ngIf="tripForm.get('estimatedDuration')?.hasError('min')">
          La durée doit être positive
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Statut -->
    <mat-form-field appearance="outline" class="trip-field trip-field--wide">
      <mat-label>Statut du voyage</mat-label>
      <mat-select formControlName="tripStatus" placeholder="Sélectionner un statut">
        <mat-option *ngFor="let status of tripStatuses" [value]="status.value">
          {{ status.label }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="tripForm.get('tripStatus')?.hasError('required')">
        Le statut du voyage est obligatoire
      </mat-error>
    </mat-form-field>

    <!-- New: Quick add section -->
    <div class="quick-add-section" *ngIf="ordersForQuickAdd.length > 0">
      <div class="section-header">
        <h3>Ajout rapide de commandes</h3>
        <p class="text-sm text-gray-500">Commandes disponibles en attente de livraison</p>
      </div>
      
      <div class="quick-add-grid">
        <div *ngFor="let order of ordersForQuickAdd" class="quick-add-card" (click)="quickAddOrder(order)">
          <div class="quick-add-header">
            <div class="order-ref">{{ order.reference }}</div>
            <!--<div class="order-type">{{ order.type || 'Sans type' }}</div>-->
          </div>
          <div class="quick-add-content">
            <div class="quick-add-client">{{ getClientName(order.customerId) }}</div>
            <div class="quick-add-address">{{ getClientAddress(order.customerId) }}</div>
            <div class="quick-add-meta">
              <span class="weight">{{ order.weight }} kg</span>
              <span class="status">{{ order.status }}</span>
            </div>
          </div>
          <button mat-icon-button class="quick-add-btn">
            <mat-icon>add_circle</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Section des livraisons -->
    <div class="deliveries-section">
      <div class="section-header">
        <h3>Livraisons</h3>
        <div class="section-header-actions">
          <p class="text-sm text-gray-500">Ajoutez les points de livraison avec leurs clients et commandes</p>
          <button 
            mat-stroked-button 
            type="button" 
            (click)="addDelivery()"
            class="add-delivery-top-btn"
          >
            <mat-icon>add</mat-icon>
            Ajouter une livraison
          </button>
        </div>
      </div>
      
      <!-- Visual Timeline -->
      <div class="delivery-timeline" *ngIf="deliveries.length > 0">
        <!-- Start Point -->
        <div class="timeline-start">
          <div class="timeline-node start-node">
            <mat-icon>play_arrow</mat-icon>
          </div>
          <div class="timeline-content start-content">
            <div class="timeline-title">Départ</div>
            <div class="timeline-details">
              <div><strong>Camion:</strong> {{ getSelectedTruckInfo() }}</div>
              <div><strong>Chauffeur:</strong> {{ getSelectedDriverInfo() }}</div>
              <div><strong>Date:</strong> {{ tripForm.get('estimatedStartDate')?.value | date:'dd MMM yyyy' }}</div>
            </div>
          </div>
        </div>

        <!-- Delivery Points -->

<div class="timeline-deliveries">
  <div *ngFor="let deliveryGroup of deliveryControls; let i = index" 
       [formGroup]="deliveryGroup" 
       class="delivery-timeline-item">
    
    <div class="timeline-connection">
      <div class="connection-line"></div>
      <div class="connection-arrow">
        <mat-icon>arrow_downward</mat-icon>
      </div>
      <div class="connection-label">Livraison {{ i + 1 }}</div>
    </div>

    <div class="timeline-node delivery-node">
      <div class="delivery-number">{{ i + 1 }}</div>
    </div>
    
    <div class="timeline-content delivery-content">
      <div class="delivery-card-header">
        <h4>Livraison {{ i + 1 }}</h4>
        <div class="delivery-actions">
          <span class="sequence-badge">Ordre #{{ deliveryGroup.get('sequence')?.value }}</span>
          <button 
            mat-icon-button 
            type="button" 
            (click)="removeDelivery(i)"
            *ngIf="deliveries.length > 1"
            class="remove-delivery-btn"
            matTooltip="Supprimer cette livraison"
          >
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
      
      <div class="delivery-form-fields">
        <!-- Client -->
        <mat-form-field appearance="outline" class="delivery-field">
          <mat-label>Client</mat-label>
          <mat-select formControlName="customerId" (selectionChange)="onCustomerChange(i)">
            <mat-option *ngFor="let customer of customers" [value]="customer.id">
              <div class="client-option">
                <div class="client-name">{{ customer.name }}</div>
                <div *ngIf="customer.matricule" class="client-matricule">
                  {{ customer.matricule }}
                </div>
              </div>
            </mat-option>
          </mat-select>
          <mat-error *ngIf="deliveryGroup.get('customerId')?.hasError('required')">
            La sélection d'un client est obligatoire
          </mat-error>
        </mat-form-field>

        <!-- Order Preview -->
        <div class="order-preview" *ngIf="deliveryGroup.get('customerId')?.value">
          <div class="order-preview-header">
            <mat-icon class="preview-icon">inventory</mat-icon>
            <span>Commandes disponibles</span>
          </div>
          <div class="order-list">
            <div *ngFor="let order of getCustomerOrders(i)" 
                 class="order-item"
                 [class.selected]="deliveryGroup.get('orderId')?.value === order.id"
                 (click)="selectOrder(i, order)">
              <div class="order-ref">{{ order.reference }}</div>
              <div class="order-details">
                <!--<span class="order-type">{{ order.type || 'Non spécifié' }}</span> -->
                <span class="order-weight">{{ order.weight }} kg</span>
              </div>
            </div>
            <div *ngIf="getCustomerOrders(i).length === 0" class="no-orders">
              Aucune commande disponible pour ce client
            </div>
          </div>
        </div>

        <!-- Commande (hidden but still functional) -->
        <mat-form-field appearance="outline" class="delivery-field hidden">
          <mat-label>Commande</mat-label>
          <mat-select formControlName="orderId">
            <mat-option *ngFor="let order of getCustomerOrders(i)" [value]="order.id">
              {{ order.reference }} - {{ order.weight }} kg
            </mat-option>
          </mat-select>
          <mat-error *ngIf="deliveryGroup.get('orderId')?.hasError('required')">
            La sélection d'une commande est obligatoire
          </mat-error>
        </mat-form-field>

        <!-- Delivery Summary Card -->
        <div class="delivery-summary-card" *ngIf="deliveryGroup.get('orderId')?.value">
          <div class="summary-header">
            <mat-icon>summarize</mat-icon>
            <h5>Résumé de la livraison</h5>
          </div>
          <div class="summary-content">
            <div class="summary-row">
              <span class="summary-label">Client:</span>
              <span class="summary-value">{{ getClientName(deliveryGroup.get('customerId')?.value) }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">Commande:</span>
              <span class="summary-value">{{ getOrderReference(deliveryGroup.get('orderId')?.value) }}</span>
            </div>
            <!--<div class="summary-row">
              <span class="summary-label">Type:</span>
              <span class="summary-value">{{ getOrderType(deliveryGroup.get('orderId')?.value) }}</span>
            </div>-->
            <div class="summary-row">
              <span class="summary-label">Poids:</span>
              <span class="summary-value">{{ getOrderWeight(deliveryGroup.get('orderId')?.value) }} kg</span>
            </div>
          </div>
        </div>

        <!-- Adresse de livraison -->
        <mat-form-field appearance="outline" class="delivery-field delivery-field--wide">
          <mat-label>Adresse de livraison</mat-label>
          <textarea
            matInput
            formControlName="deliveryAddress"
            placeholder="Ex: Rue de la Paix, 75001 Paris"
            rows="2"
          ></textarea>
          <mat-error *ngIf="deliveryGroup.get('deliveryAddress')?.hasError('required')">
            L'adresse de livraison est obligatoire
          </mat-error>
        </mat-form-field>

        <div class="delivery-row">
          <!-- Séquence -->
          <mat-form-field appearance="outline" class="delivery-field">
            <mat-label>Ordre de livraison</mat-label>
            <input
              matInput
              type="number"
              formControlName="sequence"
              min="1"
              [max]="deliveries.length"
              placeholder="Ex: 1"
            />
            <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('required')">
              L'ordre de livraison est obligatoire
            </mat-error>
            <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('min')">
              L'ordre doit être au moins 1
            </mat-error>
            <mat-error *ngIf="deliveryGroup.get('sequence')?.hasError('max')">
              L'ordre ne peut pas dépasser {{ deliveries.length }}
            </mat-error>
          </mat-form-field>

          <!-- Heure prévue -->
          <mat-form-field appearance="outline" class="delivery-field">
            <mat-label>Heure prévue</mat-label>
            <input
              matInput
              type="time"
              formControlName="plannedTime"
            />
          </mat-form-field>
        </div>

        <!-- Notes -->
        <mat-form-field appearance="outline" class="delivery-field delivery-field--wide">
          <mat-label>Notes (optionnel)</mat-label>
          <textarea
            matInput
            formControlName="notes"
            placeholder="Informations supplémentaires..."
            rows="2"
          ></textarea>
        </mat-form-field>
      </div>
    </div>
  </div>
</div>
        <!-- End Point -->
        <div class="timeline-connection">
          <div class="connection-line"></div>
          <div class="connection-arrow">
            <mat-icon>arrow_downward</mat-icon>
          </div>
          <div class="connection-label">Fin du trajet</div>
        </div>

        <div class="timeline-end">
          <div class="timeline-node end-node">
            <mat-icon>flag</mat-icon>
          </div>
          <div class="timeline-content end-content">
            <div class="timeline-title">Arrivée</div>
            <div class="timeline-details">
              <div><strong>Date de fin:</strong> {{ tripForm.get('estimatedEndDate')?.value | date:'dd MMM yyyy' }}</div>
              <div><strong>Distance totale:</strong> {{ tripForm.get('estimatedDistance')?.value }} km</div>
              <div><strong>Durée estimée:</strong> {{ tripForm.get('estimatedDuration')?.value }} heures</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="deliveries.length === 0" class="empty-deliveries">
        <mat-icon class="empty-icon">local_shipping</mat-icon>
        <h4>Aucune livraison ajoutée</h4>
        <p>Commencez par ajouter des points de livraison à votre trajet</p>
        <button 
          mat-raised-button 
          color="primary" 
          type="button" 
          (click)="addDelivery()"
          class="add-first-delivery-btn"
        >
          <mat-icon>add</mat-icon>
          Ajouter la première livraison
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="form-footer">
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="tripForm.invalid || deliveries.length === 0"
      >
        {{ data.tripId ? 'Enregistrer' : 'Créer le voyage' }}
      </button>
      <button mat-button type="button" (click)="onCancel()">Annuler</button>
    </div>
  </form>
</mat-card>